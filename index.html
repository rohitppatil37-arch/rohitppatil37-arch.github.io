<!DOCTYPE html>
<html lang="mr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ЁЯУЭ рдорд╛рддреАрдХрд╛рдо рдкреНрд░рдЧрддреА тАФ рдорд╢реАрди</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --card-radius: 14px;
        --glass-bg: rgba(255, 255, 255, 0.6);
        --accent1: #06b6d4;
        --accent2: #7c3aed;
        --muted: #5b6570;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Noto Sans Devanagari", system-ui, sans-serif;
        background: linear-gradient(135deg, #e6f0ff 0%, #f7fbff 60%);
        padding: 28px;
        color: #0b1723;
        -webkit-font-smoothing: antialiased;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 20px;
      }
      @media (max-width: 1000px) {
        .wrap {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.75),
          rgba(255, 255, 255, 0.6)
        );
        border-radius: var(--card-radius);
        padding: 18px;
        box-shadow: 0 10px 30px rgba(11, 20, 35, 0.08);
        border: 1px solid rgba(11, 20, 35, 0.04);
        backdrop-filter: blur(6px) saturate(120%);
      }
      .hero {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .logo {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 24px;
      }
      h1 {
        margin: 0;
        font-size: 18px;
      }
      p.lead {
        margin: 6px 0 14px;
        color: var(--muted);
        font-size: 13px;
      }

      form .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      @media (max-width: 720px) {
        form .grid {
          grid-template-columns: 1fr;
        }
      }
      label {
        display: block;
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="number"],
      input[type="time"],
      select,
      textarea,
      input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(11, 20, 35, 0.06);
        background: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        outline: none;
        transition: box-shadow 0.12s, transform 0.08s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.12);
        transform: translateY(-2px);
        border-color: rgba(99, 102, 241, 0.45);
      }
      .full {
        grid-column: 1/-1;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 12px;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 800;
        color: white;
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        box-shadow: 0 10px 28px rgba(99, 102, 241, 0.14);
      }
      .btn.ghost {
        background: transparent;
        color: #0b1723;
        border: 1px solid rgba(11, 20, 35, 0.06);
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }

      .dash-col {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: sticky;
        top: 20px;
      }
      .dash-card {
        padding: 14px;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.65),
          rgba(255, 255, 255, 0.55)
        );
        border: 1px solid rgba(11, 20, 35, 0.04);
      }
      .big {
        font-size: 20px;
        font-weight: 900;
        color: #0b3a66;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid rgba(11, 20, 35, 0.06);
        padding: 8px;
        text-align: center;
        font-size: 13px;
      }
      th {
        background: rgba(11, 20, 35, 0.04);
      }
      .green {
        color: green;
        font-weight: 700;
      }
      .red {
        color: red;
        font-weight: 700;
      }
      footer.note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .chart-wrap {
        overflow-x: auto;
      }
      .glow {
        box-shadow: 0 0 12px rgba(0, 200, 0, 0.6);
        transition: box-shadow 0.5s ease-out;
      }
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.25s ease, visibility 0.25s ease;
        z-index: 9999;
      }
      .popup.show {
        visibility: visible;
        opacity: 1;
      }
      .popup-content {
        background: #ffffff;
        padding: 20px 26px;
        border-radius: 12px;
        text-align: center;
        max-width: 360px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.8);
        opacity: 0;
        transition: all 0.3s ease;
      }
      .popup.show .popup-content {
        transform: scale(1);
        opacity: 1;
      }
      .popup-content h2 {
        margin: 0 0 8px;
        color: #0b8a2f;
        font-size: 18px;
      }
      .popup-content p {
        margin: 0;
        font-size: 14px;
        color: #223344;
      }
      .checkmark-circle {
        width: 80px;
        height: 80px;
        position: relative;
        display: inline-block;
        vertical-align: top;
        margin-bottom: 12px;
      }
      .checkmark-circle .background {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #4caf50;
        position: absolute;
        top: 0;
        left: 0;
      }
      .checkmark {
        width: 28px;
        height: 56px;
        border-right: 6px solid white;
        border-bottom: 6px solid white;
        transform: rotate(45deg) scale(0.5);
        position: absolute;
        top: 12px;
        left: 24px;
        opacity: 0;
      }
      .checkmark.draw {
        animation: checkmark 0.6s ease forwards;
        animation-delay: 0.2s;
      }
      @keyframes checkmark {
        from {
          opacity: 0;
          transform: rotate(45deg) scale(0.5);
        }
        to {
          opacity: 1;
          transform: rotate(45deg) scale(1);
        }
      }
      .summary-heading {
        margin: 10px 0;
        text-align: center;
        color: #0b3a66;
        font-size: 16px;
        font-weight: 800;
      }
      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      .table-container table {
        min-width: 400px;
      }
      .mic-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid rgba(11, 20, 35, 0.06);
        background: transparent;
        cursor: pointer;
        margin-left: 8px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      .mic-btn.recording {
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.25);
        background: rgba(99, 102, 241, 0.06);
        animation: pulse 1.5s infinite;
      }
      .mic-indicator {
        font-size: 12px;
        color: #0b3a66;
        margin-left: 8px;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body>
    <div id="formPage" class="wrap">
      <div class="card">
        <div class="hero">
          <div class="logo">рдЧ</div>
          <div>
            <h1>ЁЯУЭ рдорд╛рддреАрдХрд╛рдо рдкреНрд░рдЧрддреА тАФ рдорд╢реАрди</h1>
            <p class="lead">рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рдорд░рд╛рдареАрдд рдиреАрдЯ рдкрдгреЗ рднрд░рд╛рд╡реА</p>
          </div>
        </div>

        <form id="mainForm" autocomplete="off" novalidate>
          <div class="grid">
            <div>
              <label for="todayDate">ЁЯУЕ рдЖрдЬрдЪрд╛ рджрд┐рдирд╛рдВрдХ</label>
              <input id="todayDate" type="date" required />
            </div>

            <div>
              <label for="workType">ЁЯОЫ рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
              <select id="workType" required>
                <option value="" disabled selected>
                  рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛...
                </option>
                <option value="рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛">рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛</option>
                <option value="рдорд╛рддреАрдХрд╛рдо">рдорд╛рддреАрдХрд╛рдо</option>
              </select>
              <div class="hint">рдкреНрд░рдХрд▓реНрдкрд╛рдЪреНрдпрд╛ рдпрд╛рджреАрд╕рд╛рдареА рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛</div>
            </div>

            <div>
              <label for="projectName">ЁЯПЧ рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡</label>
              <select id="projectName" required>
                <option value="" disabled selected>
                  рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡ рдирд┐рд╡рдбрд╛...
                </option>
              </select>
            </div>

            <div>
              <label for="machineType">тЪЩя╕П рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
              <select id="machineType" required>
                <option value="" disabled selected>
                  рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛...
                </option>
                <option value="рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░">рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░</option>
                <option value="рдЯрд┐рдкрд░">рдЯрд┐рдкрд░</option>
                <option value="рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░">рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░</option>
                <option value="рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ">рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ</option>
              </select>
            </div>

            <div>
              <label for="driver">ЁЯС╖ рдЪрд╛рд▓рдХрд╛рдЪреЗ рдирд╛рд╡</label>
              <select id="driver" required>
                <option value="" disabled selected>рдЪрд╛рд▓рдХ рдирд┐рд╡рдбрд╛...</option>
                <option>рд░рд╛рдЬреЗрдВрджреНрд░ рдирд╛рдЧреВ рдЬрд╛рдзрд╡</option>
                <option>рд░рд╛рдЬреЗрдВрджреНрд░ рдХрджрдо</option>
                <option>рдирд┐рд▓реЗрд╢ рдорд╛рд░реБрддреА рдЪрд╡реНрд╣рд╛рдг</option>
                <option>рдореБрдмрд╛рд░рдХ рдЗрд╕реНрдорд╛рдИрд▓ рд╣рдбрдкреЛрд▓рдХрд░</option>
                <option>рд░рд╡реАрдВрджреНрд░ рддреБрдХрд╛рд░рд╛рдо рджреЗрд╕рд╛рдИ</option>
                <option>рд╕реБрд░реЗрд╢ рдкрд╛рдВрдбреБрд░рдВрдЧ рдмрд╛рдЧрд╡реЗ</option>
                <option>рд╕реБрд░реЗрд╢ рдирд╛рд░рд╛рдпрдг рдирд┐рдВрдмрд╛рд│рдХрд░</option>
                <option>рднрд╛рдЧрд╡рдд рдореЛрд╣рди рд╕реБрд│</option>
                <option>рдореЛрд╣рд╕реАрди рдЗрдХреНрдмрд╛рд▓ рд╕рдпреНрдпрдж</option>
                <option>рд╕рд░рдлрд░рд╛рдЭ рдЕрдлрд╕рд╛рд░ рд╢реЗрдЦ</option>
              </select>
            </div>

            <div>
              <label for="machine">ЁЯУЛ рд╕рдпрдВрддреНрд░рд╛рдЪреЗ рдирд╛рд╡</label>
              <select id="machine" required>
                <option value="" disabled selected>рд╕рдпрдВрддреНрд░ рдирд┐рд╡рдбрд╛...</option>
              </select>
            </div>

            <div class="full">
              <label for="dieselQty">тЫ╜ рдЖрдЬ рдХрд┐рддреА рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ (рд▓рд┐рдЯрд░ рдордзреНрдпреЗ)</label>
              <input
                id="dieselQty"
                type="number"
                min="0"
                step="0.1"
                placeholder="рдЙрджрд╛. 25.5 рдЖрдгрд┐ рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╕реЗрд▓ рддрд░ 0 рд▓рд┐рд╣рд╛"
                required
              />
              <div class="hint">рджрд╢рд╛рдВрд╢ рд╕реНрд╡реАрдХрд╛рд░рд▓реЗ рдЬрд╛рддреАрд▓ (рдЙрджрд╛. 12.5)</div>
            </div>

            <div>
              <label for="dieselTime">ЁЯХТ рдбрд┐рдЭреЗрд▓ рднрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
              <input
                id="dieselTime"
                type="time"
                placeholder="рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╕реЗрд▓ рддрд░ рд╣рд╛ рдкреНрд░рд╢реНрди рд╡рдЧрд│рд╛"
                required
              />
            </div>

            <div>
              <label for="dieselReading"
                >ЁЯУЯ рдбрд┐рдЭреЗрд▓ рднрд░рдгреНрдпрд╛рд╡реЗрд│реА Dashboard Reading (рддрд╛рд╕/km)</label
              >
              <input
                id="dieselReading"
                type="number"
                placeholder="рдЙрджрд╛. 12345"
                required
              />
            </div>

            <div>
              <label for="startReading"
                >тЦ╢я╕П рдХрд╛рдо рд╕реБрд░реВ рдХрд░рддрд╛рдирд╛рдЪреЗ Dashboard Reading (рддрд╛рд╕/km)</label
              >
              <input
                id="startReading"
                type="number"
                placeholder="рдЙрджрд╛. 500 рдХрд┐рдВрд╡рд╛ 12000"
                required
              />
            </div>

            <div>
              <label for="endReading"
                >тП╣ рдХрд╛рдо рдерд╛рдВрдмрд╡рддрд╛рдирд╛рдЪреЗ Dashboard Reading (рддрд╛рд╕/km)</label
              >
              <input
                id="endReading"
                type="number"
                placeholder="рдЙрджрд╛. 510 рдХрд┐рдВрд╡рд╛ 12050"
                required
              />
            </div>

            <div class="full">
              <label for="totalHoursReading"
                >тЪб Dashboard рдиреБрд╕рд╛рд░ рдЖрдЬрдЪреЗ рдПрдХреВрдг рддрд╛рд╕ / рдХрд┐рдореА</label
              >
              <input
                id="totalHoursReading"
                type="text"
                placeholder="ЁЯФД рдЧрдгрдирд╛ рдЖрдкреЛрдЖрдк рд╣реЛрдИрд▓"
                readonly
              />
              <div class="hint">
                endReading - startReading = рдЖрдЬрдЪрд╛ рдПрдХреВрдг рддрд╛рд╕ / рдХрд┐рдореА
              </div>
            </div>

            <div id="locationWrapper" class="full" style="display: none">
              <label for="locationFromTo"
                >ЁЯУН рдпрд╛ рдард┐рдХрд╛рдгрд╛рдкрд╛рд╕реВрди рддреЗ рддреНрдпрд╛ рдард┐рдХрд╛рдгрд╛рдкрд░реНрдпрдВрдд</label
              >
              <div style="display: flex; align-items: center; gap: 8px">
                <input
                  id="locationFromTo"
                  type="text"
                  placeholder="рдЙрджрд╛. рд╕рд╛рдЗрдЯ A - рдбрдВрдкрдпрд╛рд░реНрдб"
                  style="flex: 1"
                  required
                />
                <button
                  type="button"
                  id="micLocation"
                  class="mic-btn"
                  title="рд╡реНрд╣реЙрдЗрд╕рдиреЗ рднрд░рд╛"
                >
                  ЁЯОЩя╕П
                </button>
                <span id="locIndicator" class="mic-indicator"></span>
              </div>
              <div class="hint">
                рдард┐рдХрд╛рдгрд╛рд╕рд╛рдареА рдмреЛрд▓рд╛ тАФ "рд╕рд╛рдЗрдЯ A рддреЗ рдбрдВрдкрдпрд╛рд░реНрдб" рдХрд┐рдВрд╡рд╛ "рд╕рд╛рдЗрдЯ A -
                рдбрдВрдкрдпрд╛рд░реНрдб".
              </div>

              <label for="tripCount" style="margin-top: 8px"
                >ЁЯЪЫ рдЯреНрд░рд┐рдк рд╕рдВрдЦреНрдпрд╛ (рдЙрджрд╛. 5)</label
              >
              <input
                id="tripCount"
                type="number"
                min="0"
                placeholder="рдЙрджрд╛. 5"
                required
              />
              <div class="hint">
                рд╡реНрд╣реЙрдЗрд╕ рдЖрдпрдирдкреБрдЯрдиреЗ рд╕рдВрдЦреНрдпрд╛ рд╕рд╛рдкрд░рд▓реНрдпрд╛рд╕ auto-fill рд╣реЛрдИрд▓; рдирд╕реЗрд▓ рддрд░ рдЗрдереЗ
                рднрд░рд╛.
              </div>
            </div>

            <div>
              <label for="shift1Start">ЁЯМЕ рдкрд╣рд┐рд▓рд╛ Shift рд╕реБрд░реВ рдХрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
              <input id="shift1Start" type="time" required />
            </div>
            <div>
              <label for="shift1End">ЁЯМЗ рдкрд╣рд┐рд▓рд╛ Shift рдерд╛рдВрдмрд╡рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
              <input id="shift1End" type="time" required />
            </div>

            <div>
              <label for="shift2Start">ЁЯМЩ рджреБрд╕рд░рд╛ Shift рд╕реБрд░реВ рдХрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
              <input id="shift2Start" type="time" required />
            </div>
            <div>
              <label for="shift2End">ЁЯММ рджреБрд╕рд░рд╛ Shift рдерд╛рдВрдмрд╡рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
              <input id="shift2End" type="time" required />
            </div>

            <div class="full">
              <label for="totalShiftHours">ЁЯХУ рд╢рд┐рдлреНрдЯрдиреБрд╕рд╛рд░ рдПрдХреВрдг рдХрд╛рдорд╛рдЪреЗ рддрд╛рд╕</label>
              <input
                id="totalShiftHours"
                type="text"
                placeholder="ЁЯФД рдЧрдгрдирд╛ рдЖрдкреЛрдЖрдк рд╣реЛрдИрд▓"
                readonly
              />
            </div>
          </div>

          <div class="actions full">
            <button type="button" class="btn" id="submitBtn">
              тЬЕ рд╕рдмрдорд┐рдЯ рдХрд░рд╛
            </button>
            <button type="button" class="btn" id="resetBtn">тЩ╗я╕П рд░реАрд╕реЗрдЯ</button>
            <button type="button" class="btn" onclick="redirectToDashboard()">
              ЁЯУК Dashboard рдкрд╛рд╣рд╛
            </button>
            <button type="button" class="btn" onclick="showAdminLogin()">
              ЁЯФС Admin Login
            </button>
          </div>

          <div class="small" style="margin-top: 8px" id="status">
            тЪая╕П рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рднрд░реВрди 'рд╕рдмрдорд┐рдЯ рдХрд░рд╛' рджрд╛рдмрд╛.
          </div>
          <div class="small" style="margin-top: 12px; text-align: center">
            ЁЯХШ рд╡реЗрд│: <span id="nowStamp">тАФ</span>
          </div>
        </form>
      </div>
    </div>

    <div id="dashboardPage" class="wrap" style="display: none">
      <div
        class="actions full"
        style="justify-content: center; margin-top: 16px"
      >
        <button type="button" class="btn" onclick="showFormPage()">
          ЁЯУЭ рдкрд░рдд Form рдкрд╛рд╣рд╛
        </button>
      </div>

      <div class="dash-col">
        <div id="summaryDiv" class="dash-card card" style="margin-top: 16px">
          ЁЯФД рдЧрдгрдирд╛ рдХрд░рдд рдЖрд╣реЗ...
        </div>
        <div class="dash-card card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <div class="small">ЁЯУК рдорд╛рдЭрд╛ рдорд╢реАрди рдбреЕрд╢рдмреЛрд░реНрдб</div>
              <div style="font-weight: 800; margin-top: 8px">
                рдлрдХреНрдд рдирд┐рд╡рдбрд▓реЗрд▓реНрдпрд╛ рдорд╢реАрдирдЪреА рдорд╛рд╣рд┐рддреА
              </div>
            </div>
            <div style="font-size: 22px; color: #0b3a66; font-weight: 900">
              тЫ╜
            </div>
          </div>

          <div style="margin-top: 12px">
            <label>тЪЩя╕П рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
            <select id="dashMachineType">
              <option value="">--- рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛ ---</option>
              <option value="рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░">рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░</option>
              <option value="рдЯрд┐рдкрд░">рдЯрд┐рдкрд░</option>
              <option value="рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░">рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░</option>
              <option value="рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ">рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ</option>
            </select>
          </div>

          <div style="margin-top: 12px">
            <label>ЁЯУЛ рдорд╢реАрди / рд╡рд╛рд╣рди</label>
            <select id="dashMachine">
              <option value="">--- рдорд╢реАрди рдирд┐рд╡рдбрд╛ ---</option>
            </select>
          </div>

          <div style="margin-top: 12px">
            <label>ЁЯУЖ рд╕реБрд░реБрд╡рд╛рддреАрдЪреА рддрд╛рд░реАрдЦ</label>
            <input type="date" id="startDate" />
          </div>
          <div style="margin-top: 8px">
            <label>ЁЯУЖ рд╢реЗрд╡рдЯрдЪреА рддрд╛рд░реАрдЦ</label>
            <input type="date" id="endDate" />
          </div>

          <div style="margin-top: 12px; display: flex; gap: 8px">
            <button class="btn" id="dashFetchBtn">ЁЯФБ рдЕрдкрдбреЗрдЯ</button>
          </div>

          <hr
            style="
              border: none;
              border-top: 1px dashed rgba(11, 20, 35, 0.06);
              margin: 12px 0;
            "
          />

          <div class="small">
            ЁЯЧУ рдХрд╛рд▓рд╛рд╡рдзреА: рдЪрд╛рд▓реВ рдорд╣рд┐рдиреНрдпрд╛рдЪреНрдпрд╛ 1 рддрд╛рд░рдЦреЗрдкрд╛рд╕реВрди рдЖрдЬрдкрд░реНрдпрдВрдд
          </div>
          <div class="big" id="dashTotal">тП│ рд▓реЛрдб рдХрд░рдд рдЖрд╣реЗ...</div>
          <div class="small" style="margin-top: 8px">
            ЁЯз╛ рдиреЛрдВрджреА: <span id="dashCount">0</span>
          </div>

          <div class="table-container">
            <table
              id="dashTable"
              border="1"
              style="width: 100%; margin-top: 20px"
            >
              <thead>
                <tr>
                  <th>рдорд╢реАрди</th>
                  <th>рдХрд╛рдо (рддрд╛рд╕ / рдХрд┐рдореА)</th>
                  <th>Actual рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)</th>
                  <th>Allowed (рд▓рд┐рдЯрд░)</th>
                  <th>рдЯреАрдк</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="dash-card card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <div class="small">тЪЦя╕П Actual vs Allowed</div>
                <div style="font-weight: 800; margin-top: 6px">
                  рдорд╢реАрди рдиреБрд╕рд╛рд░ рддреБрд▓рдирд╛
                </div>
              </div>
              <div style="font-size: 20px">ЁЯУИ</div>
            </div>
            <div class="chart-wrap" style="margin-top: 12px">
              <canvas id="consumptionGraph" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminPage" class="wrap" style="display: none">
      <div class="card">
        <h2>ЁЯУС Download Reports</h2>

        <h3 style="margin-top: 20px; color: #0b3a66">
          ЁЯЧУ Download Monthly Report
        </h3>
        <label for="reportMonth">ЁЯУЕ Select Month & Year</label>
        <input id="reportMonth" type="month" />
        <button
          class="btn"
          style="margin-top: 10px"
          onclick="generateMonthlyReport()"
        >
          ЁЯУе Download Monthly Report
        </button>
        <div
          id="monthlyReportStatus"
          class="small"
          style="margin-top: 12px"
        ></div>
        <div id="monthlyReportLink" style="margin-top: 12px"></div>

        <hr style="margin: 20px 0" />

        <h3 style="margin-top: 20px; color: #0b3a66">
          ЁЯУК Download Three-Month Report
        </h3>
        <label for="quarterYear">ЁЯУЕ Select Year</label>
        <input
          id="quarterYear"
          type="number"
          placeholder="рдЙрджрд╛. 2025"
          min="2020"
          max="2100"
        />

        <label for="quarterSelect" style="margin-top: 10px"
          >ЁЯУЖ Select Quarter</label
        >
        <select id="quarterSelect">
          <option value="">--- Select Quarter ---</option>
          <option value="Q1">January тАУ March</option>
          <option value="Q2">April тАУ June</option>
          <option value="Q3">July тАУ September</option>
          <option value="Q4">October тАУ December</option>
        </select>

        <button
          class="btn"
          style="margin-top: 10px"
          onclick="generateQuarterlyReport()"
        >
          ЁЯУе Download Three-Month Report
        </button>
        <div
          id="quarterlyReportStatus"
          class="small"
          style="margin-top: 12px"
        ></div>
        <div id="quarterlyReportLink" style="margin-top: 12px"></div>

        <hr style="margin: 20px 0" />

        <h3 style="margin-top: 20px; color: #0b3a66">
          ЁЯТ░ Download рдкреНрд░рд▓рдВрдмрд┐рдд рдЦрд░реНрдЪ рдЕрд╣рд╡рд╛рд▓
        </h3>
        <label for="expenseYear">ЁЯУЕ Select Year</label>
        <input
          id="expenseYear"
          type="number"
          placeholder="рдЙрджрд╛. 2025"
          min="2020"
          max="2100"
        />

        <label for="expenseQuarter" style="margin-top: 10px"
          >ЁЯУЖ Select Quarter</label
        >
        <select id="expenseQuarter">
          <option value="">--- Select Quarter ---</option>
          <option value="Q1">January тАУ March</option>
          <option value="Q2">April тАУ June</option>
          <option value="Q3">July тАУ September</option>
          <option value="Q4">October тАУ December</option>
        </select>

        <button
          class="btn"
          style="margin-top: 10px"
          onclick="generateExpenseReport()"
        >
          ЁЯУе Download Expense Report
        </button>
        <div
          id="expenseReportStatus"
          class="small"
          style="margin-top: 12px"
        ></div>
        <div id="expenseReportLink" style="margin-top: 12px"></div>

        <div class="actions" style="margin-top: 20px">
          <button class="btn ghost" onclick="backToForm()">тмЕя╕П Back</button>
        </div>
      </div>
    </div>

    <div id="successPopup" class="popup" aria-hidden="true">
      <div class="popup-content">
        <div class="checkmark-circle">
          <div class="background"></div>
          <div class="checkmark"></div>
        </div>
        <h2>рдорд╛рд╣рд┐рддреА рдЬрддрди рдЭрд╛рд▓реА!</h2>
        <p>рддреБрдордЪреА рдорд╛рд╣рд┐рддреА Google Sheet рдордзреНрдпреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдЭрд╛рд▓реА рдЖрд╣реЗ.</p>
      </div>
    </div>

    <script>
      const ADMIN_CODE = "123456";
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbzT-vob4JQLy3ia3Kt26kX9XPOFd0-90zoucFXnLrFWEaO6Vitxpw-k_2SdEi8oIZiPww/exec";

      const machineRates = {
        рдЬреЗрд╕реАрдмреА: 13,
        рд╕реЕрдиреА: 23,
        "рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА": 20,
        рд╢рд╛рдВрддреБрдИ: 14,
        рдмреАрдИрдПрдордПрд▓: 14,
      };

      const vehicleRates = {
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрез": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреи": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрек": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрел": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрем": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрен": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрео": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреп": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекреж": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрез": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрей": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрек": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрел": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрем": 1.6,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреоремрео": 1.6,
        "рдЖрдпрд╢рд░ релрежрезрем рдкреНрд░реЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ рейреп рдП рдбреА режрелреиреж": 2.3,
        "рейрел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░реЕрдХреЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреирезрек": 1.9,
        "реирел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░рдХреНрд╕реЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреиреирел": 2.3,
        "рдЯрд╛рдЯрд╛ рдЭреЗрдиреЙрди рдпреЛрджреНрдзрд╛ рдХреНрд░.рдПрдо рдПрдЪ режрео рдП рдкреА резреирекрек": 13,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдХреЕрдореНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ режрео рдЬреА режрейрекрек": 13,
        "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдкрд┐рдХрдЕрдк рдХреНрд░.рдПрдо рдПрдЪ резрез рдП рдмреА режреиренреж": 13,
      };

      const projects = {
        "рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛": [
          "рдзреЛрдо рдбрд╛рд╡рд╛ рдХрд╛рд▓рд╡рд╛",
          "рддрд┐рд▓рд╛рд░реА рдЙрдЬрд╡рд╛ рдХрд╛рд▓рд╡рд╛",
          "рдмрд╛рдВрджрд╛ рд╢рд╛рдЦрд╛ рдХрд╛рд▓рд╡рд╛",
          "рд╕рд▓рдЧрд░реЗ рдореБрдЦреНрдп рдХрд╛рд▓рд╡рд╛",
        ],
        рдорд╛рддреАрдХрд╛рдо: [
          "рд╡рд╛рд╢рд┐рд╖реНрдареА рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ рддрд╛. рдЪрд┐рдкрд│реВрдг (рдЯрдкреНрдкрд╛-рез)",
          "рд╡рд╛рд╢рд┐рд╖реНрдареА рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ рддрд╛. рдЪрд┐рдкрд│реВрдг (рдЯрдкреНрдкрд╛-реи)",
          "рдЬрдЧрдмреБрдбреА рдирджреА рддрд╛.рдЦреЗрдб рдЬрд┐.рд░рддреНрдирд╛рдЧрд┐рд░реА рдпреЗрдереАрд▓ рдЧрд╛рд│ рд╡ рдмреЗрдЯреЗ рдХрд╛рдврдгреЗ",
          "рдореМрдЬреЗ рдорд╛рдЦрдЬрди рдпреЗрдереАрд▓ рд╕реНрдерд╛рдирд┐рдХ рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ. рдЬрд┐.рд░рддреНрдирд╛рдЧрд┐рд░реА",
        ],
      };

      const machines = {
        "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░": [
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрем",
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрен",
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрео",
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренреп",
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренреореж",
          "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренреорез",
          "рд╕реЕрдиреА рдПрд╕ рд╡рд╛рдп рейрелреж рдХреНрд░. ремреирео",
          "рд╕реЕрдиреА рдПрд╕ рд╡рд╛рдп рейрелреж рдХреНрд░. ремрелрео",
          "рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА рдИрдПрдХреНрд╕рейрелреж рдХреНрд░. режрекрежрек",
          "рдбреЛрдЭрд░ рд╢рд╛рдВрддреБрдИ рдПрд╕рдбреАрезрем рдХреНрд░. резрежреорепремрео",
          "рдбреЛрдЭрд░ рдмреАрдИрдПрдордПрд▓ рдмреАрдбреАреореж рдХреНрд░. резрелрейрекрен",
        ],
        рдЯрд┐рдкрд░: [
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрез",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреи",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрек",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрел",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрем",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрен",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрео",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреп",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекреж",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрез",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрей",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрек",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрел",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрем",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреоремрео",
          "рдЖрдпрд╢рд░ релрежрезрем рдкреНрд░реЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ рейреп рдП рдбреА режрелреиреж",
        ],
        рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░: [
          "рейрел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░реЕрдХреЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреирезрек",
          "реирел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░рдХреНрд╕реЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреиреирел",
        ],
        "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ": [
          "рдЯрд╛рдЯрд╛ рдЭреЗрдиреЙрди рдпреЛрджреНрдзрд╛ рдХреНрд░.рдПрдо рдПрдЪ режрео рдП рдкреА резреирекрек",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдХреЕрдореНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ режрео рдЬреА режрейрекрек",
          "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдкрд┐рдХрдЕрдк рдХреНрд░.рдПрдо рдПрдЪ резрез рдП рдмреА режреиренреж",
        ],
      };

      let records = [];
      let chart;
      let recognitionInstance = null;
      let isRecognitionActive = false;

      function hideAndClearExtraFields() {
        const wrap = document.getElementById("locationWrapper");
        if (wrap) wrap.style.display = "none";
        const loc = document.getElementById("locationFromTo");
        const trip = document.getElementById("tripCount");
        if (loc) {
          loc.required = false;
          loc.value = "";
        }
        if (trip) {
          trip.required = false;
          trip.value = "";
        }
      }

      function toNumber(v) {
        if (v == null) return 0;
        const s = String(v)
          .trim()
          .replace(/,/g, ".")
          .replace(/[^\d\.\-]/g, "");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      }

      function getRateForMachine(machine) {
        if (machine.includes("рдЬреЗрд╕реАрдмреА")) return machineRates["рдЬреЗрд╕реАрдмреА"];
        if (machine.includes("рд╕реЕрдиреА")) return machineRates["рд╕реЕрдиреА"];
        if (machine.includes("рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА")) return machineRates["рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА"];
        if (machine.includes("рд╢рд╛рдВрддреБрдИ")) return machineRates["рд╢рд╛рдВрддреБрдИ"];
        if (machine.includes("рдмреАрдИрдПрдордПрд▓")) return machineRates["рдмреАрдИрдПрдордПрд▓"];
        if (vehicleRates[machine]) return vehicleRates[machine];
        return 10;
      }

      function extractTripCount(text) {
        if (!text) return "";
        console.log("Extracting trip count from:", text);
        const patterns = [
          /(\d+)\s*(?:trips?|рдЯреНрд░рд┐рдкреНрд╕?|рдЯреНрд░рд┐рдк|рдлреЗрд▒реНрдпрд╛|рдлреЗрд░реА)/i,
          /(?:trips?|рдЯреНрд░рд┐рдкреНрд╕?|рдЯреНрд░рд┐рдк|рдлреЗрд▒реНрдпрд╛|рдлреЗрд░реА)\s*(\d+)/i,
          /(\d+)/,
        ];
        for (let pattern of patterns) {
          const match = text.match(pattern);
          if (match && match[1]) {
            console.log("Trip count found:", match[1]);
            return match[1];
          }
        }
        console.log("No trip count found");
        return "";
      }

      function initVoiceForLocation() {
        const input = document.getElementById("locationFromTo");
        const btn = document.getElementById("micLocation");
        const ind = document.getElementById("locIndicator");

        if (!btn || !input) {
          console.log("тЭМ Button or input not found");
          return;
        }

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
          console.log("тЭМ Speech Recognition not supported");
          btn.style.display = "none";
          if (ind) ind.textContent = "рд╡реНрд╣реЙрдЗрд╕ рд╕рдкреЛрд░реНрдЯ рдирд╛рд╣реА";
          return;
        }

        console.log("тЬЕ Speech Recognition supported");

        recognitionInstance = new SpeechRecognition();
        recognitionInstance.continuous = false;
        recognitionInstance.interimResults = false;
        recognitionInstance.maxAlternatives = 3;
        recognitionInstance.lang = "mr-IN";

        console.log(
          "тЬЕ Recognition instance created with lang:",
          recognitionInstance.lang
        );

        recognitionInstance.onstart = function () {
          console.log("ЁЯОд Recognition started");
          isRecognitionActive = true;
          btn.classList.add("recording");
          btn.style.backgroundColor = "#e3f2fd";
          if (ind) {
            ind.textContent = "рдРрдХрдд рдЖрд╣реЗ... рдмреЛрд▓рд╛";
            ind.style.color = "blue";
          }
        };

        recognitionInstance.onspeechstart = function () {
          console.log("ЁЯЧгя╕П Speech detected");
          if (ind) {
            ind.textContent = "рдЖрд╡рд╛рдЬ рдРрдХреВ рдЖрд▓рд╛...";
            ind.style.color = "green";
          }
        };

        recognitionInstance.onsoundstart = function () {
          console.log("ЁЯФК Sound started");
        };

        recognitionInstance.onspeechend = function () {
          console.log("ЁЯЧгя╕П Speech ended - processing...");
          if (ind) {
            ind.textContent = "рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рдд рдЖрд╣реЗ...";
            ind.style.color = "orange";
          }
        };

        recognitionInstance.onresult = function (event) {
          console.log("тЬЕ Result event fired");
          console.log("Full event:", event);
          console.log("Results length:", event.results.length);

          if (event.results.length === 0) {
            console.log("тЪая╕П No results in event");
            if (ind) {
              ind.textContent = "рдХрд╛рд╣реА рдРрдХреВ рдЖрд▓реЗ рдирд╛рд╣реА";
              ind.style.color = "orange";
            }
            return;
          }

          const result = event.results[0];
          console.log("Result object:", result);
          console.log("Alternatives:", result.length);

          let allTranscripts = [];
          for (let i = 0; i < result.length; i++) {
            const alt = result[i];
            console.log(
              `Alternative ${i}: "${alt.transcript}" (confidence: ${alt.confidence})`
            );
            allTranscripts.push(alt.transcript);
          }

          const transcript = result[0].transcript.trim();
          const confidence = result[0].confidence;

          console.log("тЬЕ Final transcript:", transcript);
          console.log("тЬЕ Confidence:", confidence);

          if (!transcript) {
            console.log("тЪая╕П Empty transcript");
            if (ind) {
              ind.textContent = "рдХрд╛рд╣реА рдРрдХреВ рдЖрд▓реЗ рдирд╛рд╣реА";
              ind.style.color = "orange";
            }
            return;
          }

          input.value = transcript;
          console.log("тЬЕ Input field updated with:", transcript);

          const tripNum = extractTripCount(transcript);
          console.log("Trip count extracted:", tripNum);

          if (tripNum !== "") {
            const tripEl = document.getElementById("tripCount");
            if (tripEl) {
              tripEl.value = tripNum;
              console.log("тЬЕ Trip count field updated with:", tripNum);
            }
          }

          if (ind) {
            ind.textContent = `тЬЕ рдУрд│рдЦрд▓реЗ! (${Math.round(confidence * 100)}%)`;
            ind.style.color = "green";
          }

          setTimeout(() => {
            if (ind) ind.textContent = "";
          }, 4000);
        };

        recognitionInstance.onnomatch = function (event) {
          console.log("тЪая╕П No match event");
          if (ind) {
            ind.textContent = "рд╕рдордЬрд▓реЗ рдирд╛рд╣реА. рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛";
            ind.style.color = "orange";
          }
        };

        recognitionInstance.onerror = function (event) {
          console.error("тЭМ Recognition error:", event.error);
          console.log("Error details:", event);

          const errorMessages = {
            "no-speech": "рдЖрд╡рд╛рдЬ рдРрдХреВ рдЖрд▓рд╛ рдирд╛рд╣реА",
            "audio-capture": "рдорд╛рдпрдХреНрд░реЛрдлреЛрди рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА",
            "not-allowed": "рдорд╛рдпрдХреНрд░реЛрдлреЛрди рдкрд░рд╡рд╛рдирдЧреА рдирд╛рдХрд╛рд░рд▓реА",
            network: "рдиреЗрдЯрд╡рд░реНрдХ рддреНрд░реБрдЯреА",
            aborted: "рдРрдХрдгреЗ рдерд╛рдВрдмрд╡рд▓реЗ",
            "service-not-allowed": "рд╕реЗрд╡рд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА",
            "bad-grammar": "рд╡реНрдпрд╛рдХрд░рдг рддреНрд░реБрдЯреА",
            "language-not-supported": "рдорд░рд╛рдареА рднрд╛рд╖рд╛ рд╕рдкреЛрд░реНрдЯ рдирд╛рд╣реА",
          };

          if (ind) {
            ind.textContent =
              errorMessages[event.error] || `рддреНрд░реБрдЯреА: ${event.error}`;
            ind.style.color = "red";
          }

          setTimeout(() => {
            if (ind) ind.textContent = "";
          }, 4000);
        };

        recognitionInstance.onend = function () {
          console.log("тП╣я╕П Recognition ended");
          isRecognitionActive = false;
          btn.classList.remove("recording");
          btn.style.backgroundColor = "";

          if (ind && ind.textContent.includes("рдРрдХрдд рдЖрд╣реЗ")) {
            ind.textContent = "рдкреВрд░реНрдг рдЭрд╛рд▓реЗ";
            ind.style.color = "#666";
            setTimeout(() => {
              if (ind) ind.textContent = "";
            }, 2000);
          }
        };

        // Unified handler function
        function handleMicClick(e) {
          e.preventDefault();
          e.stopPropagation();

          console.log("ЁЯЦ▒я╕П Mic button clicked/tapped");
          console.log(
            "Current state - isRecognitionActive:",
            isRecognitionActive
          );

          if (isRecognitionActive) {
            console.log("тП╣я╕П Stopping recognition...");
            try {
              recognitionInstance.stop();
            } catch (err) {
              console.warn("Stop error:", err);
              isRecognitionActive = false;
              btn.classList.remove("recording");
            }
          } else {
            console.log("ЁЯОд Starting recognition...");
            if (ind) {
              ind.textContent = "рддрдпрд╛рд░реА рдХрд░рдд рдЖрд╣реЗ...";
              ind.style.color = "blue";
            }

            try {
              recognitionInstance.start();
              console.log("тЬЕ Start command sent");
            } catch (err) {
              console.error("тЭМ Start error:", err);
              if (ind) {
                ind.textContent = "рддреНрд░реБрдЯреА: " + err.message;
                ind.style.color = "red";
              }
              isRecognitionActive = false;
              btn.classList.remove("recording");
            }
          }
        }

        // Add both click and touchstart listeners
        btn.addEventListener("click", handleMicClick);
        btn.addEventListener("touchstart", handleMicClick, { passive: false });

        console.log("тЬЕ Voice input initialized successfully");
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("тЬЕ DOM loaded!");

        const dashMachineTypeSelect =
          document.getElementById("dashMachineType");
        const dashMachineSelect = document.getElementById("dashMachine");

        dashMachineTypeSelect.addEventListener("change", function () {
          const type = this.value;
          dashMachineSelect.innerHTML =
            '<option value="">--- рдорд╢реАрди рдирд┐рд╡рдбрд╛ ---</option>';
          if (machines[type]) {
            machines[type].forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              dashMachineSelect.appendChild(opt);
            });
          }
        });

        const today = new Date();
        const now = new Date();
        const currentMonth = now.toISOString().slice(0, 7);
        document.getElementById("reportMonth").value = currentMonth;
        document.getElementById("todayDate").value = today
          .toISOString()
          .split("T")[0];

        hideAndClearExtraFields();

        const workTypeSelect = document.getElementById("workType");
        const projectSelect = document.getElementById("projectName");
        const machineTypeSelect = document.getElementById("machineType");
        const machineSelect = document.getElementById("machine");

        workTypeSelect.addEventListener("change", function () {
          const workType = this.value;
          projectSelect.innerHTML =
            '<option value="" disabled selected>рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡ рдирд┐рд╡рдбрд╛...</option>';
          if (projects[workType]) {
            projects[workType].forEach((p) => {
              const opt = document.createElement("option");
              opt.value = p;
              opt.textContent = p;
              projectSelect.appendChild(opt);
            });
          }
        });

        machineTypeSelect.addEventListener("change", function () {
          const type = this.value;
          machineSelect.innerHTML =
            '<option value="" disabled selected>рд╕рдпрдВрддреНрд░ рдирд┐рд╡рдбрд╛...</option>';
          if (machines[type]) {
            machines[type].forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              machineSelect.appendChild(opt);
            });
          }

          const locWrap = document.getElementById("locationWrapper");
          const locInput = document.getElementById("locationFromTo");
          const tripInput = document.getElementById("tripCount");

          if (
            type === "рдЯрд┐рдкрд░" ||
            type === "рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░" ||
            type === "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ"
          ) {
            if (locWrap) locWrap.style.display = "block";
            if (locInput) {
              locInput.required = true;
            }
            if (tripInput) {
              tripInput.required = false;
            }
          } else {
            if (locWrap) locWrap.style.display = "none";
            if (locInput) {
              locInput.required = false;
              locInput.value = "";
            }
            if (tripInput) {
              tripInput.required = false;
              tripInput.value = "";
            }
          }

          machineSelect.focus();
        });

        setInterval(() => {
          const now = new Date();
          document.getElementById("nowStamp").textContent =
            now.toLocaleTimeString("mr-IN", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
        }, 1000);

        loadDataFromSheet();
        initVoiceForLocation();
      });

      document
        .getElementById("startReading")
        .addEventListener("input", calcReadingHours);
      document
        .getElementById("endReading")
        .addEventListener("input", calcReadingHours);

      function calcReadingHours() {
        const start =
          parseFloat(document.getElementById("startReading").value) || 0;
        const end =
          parseFloat(document.getElementById("endReading").value) || 0;
        const total = end > start ? end - start : 0;
        const field = document.getElementById("totalHoursReading");
        field.value = total.toFixed(1);
        field.classList.add("glow");
        setTimeout(() => field.classList.remove("glow"), 800);
      }

      ["shift1Start", "shift1End", "shift2Start", "shift2End"].forEach((id) => {
        document.getElementById(id).addEventListener("input", calcShiftHours);
      });

      function calcShiftHours() {
        function toHours(time) {
          if (!time) return 0;
          const [h, m] = time.split(":").map(Number);
          return h + m / 60;
        }
        const s1 = toHours(document.getElementById("shift1Start").value);
        const e1 = toHours(document.getElementById("shift1End").value);
        const s2 = toHours(document.getElementById("shift2Start").value);
        const e2 = toHours(document.getElementById("shift2End").value);

        let total = 0;
        if (e1 > s1) total += e1 - s1;
        if (e2 > s2) total += e2 - s2;

        const field = document.getElementById("totalShiftHours");
        field.value = total.toFixed(1);
        field.classList.add("glow");
        setTimeout(() => field.classList.remove("glow"), 800);
      }

      document
        .getElementById("dieselQty")
        .addEventListener("input", function () {
          let qty = parseFloat(this.value);
          let timeField = document.getElementById("dieselTime");
          let readingField = document.getElementById("dieselReading");

          if (!isNaN(qty) && qty > 0) {
            timeField.disabled = false;
            timeField.required = true;
            readingField.disabled = false;
            readingField.required = true;
          } else {
            timeField.value = "";
            timeField.disabled = true;
            timeField.required = false;
            readingField.value = "";
            readingField.disabled = true;
            readingField.required = false;
          }
        });

      document.getElementById("submitBtn").addEventListener("click", () => {
        const form = document.getElementById("mainForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const data = {
          рджрд┐рдирд╛рдВрдХ: document.getElementById("todayDate").value,
          "рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░": document.getElementById("workType").value,
          "рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡": document.getElementById("projectName").value,
          "рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░": document.getElementById("machineType").value,
          рдЪрд╛рд▓рдХ: document.getElementById("driver").value,
          рдорд╢реАрди: document.getElementById("machine").value,
          "рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)": document.getElementById("dieselQty").value,
          "рдбрд┐рдЭреЗрд▓ рд╡реЗрд│": document.getElementById("dieselTime").value,
          "рдбрд┐рдЭреЗрд▓ reading": document.getElementById("dieselReading").value,
          "рд╕реБрд░реБрд╡рд╛рддреАрдЪреЗ reading": document.getElementById("startReading").value,
          "рд╢реЗрд╡рдЯрдЪреЗ reading": document.getElementById("endReading").value,
          "Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)":
            document.getElementById("totalHoursReading").value,
          "рдпрд╛ рдард┐рдХрд╛рдгрд╛рдкрд╛рд╕реВрди рддреЗ рддреНрдпрд╛ рдард┐рдХрд╛рдгрд╛рдкрд░реНрдпрдВрдд": document.getElementById(
            "locationFromTo"
          )
            ? document.getElementById("locationFromTo").value.trim()
            : "",
          "рдПрдХреВрдг рдЯреНрд░рд┐рдкреНрд╕": document.getElementById("tripCount")
            ? document.getElementById("tripCount").value
            : "",
          "рд╢рд┐рдлреНрдЯ-рез рд╕реБрд░реВ рд╡реЗрд│": document.getElementById("shift1Start").value,
          "рд╢рд┐рдлреНрдЯ-рез рдмрдВрдж рд╡реЗрд│": document.getElementById("shift1End").value,
          "рд╢рд┐рдлреНрдЯ-реи рд╕реБрд░реВ рд╡реЗрд│": document.getElementById("shift2Start").value,
          "рд╢рд┐рдлреНрдЯ-реи рдмрдВрдж рд╡реЗрд│": document.getElementById("shift2End").value,
          "рдПрдХреВрдг рддрд╛рд╕ (shift)": document.getElementById("totalShiftHours").value,
        };

        let remark = "тЬЕ рдХрд╛рдо рдЭрд╛рд▓реЗ";
        if (
          !data["рд╕реБрд░реБрд╡рд╛рддреАрдЪреЗ reading"] &&
          !data["рд╢реЗрд╡рдЯрдЪреЗ reading"] &&
          (!data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] || data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] == 0)
        ) {
          remark = "ЁЯЪл рдХрд╛рдо рдЭрд╛рд▓реЗ рдирд╛рд╣реА";
        } else if (data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] == 0 || data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] === "") {
          remark = "тЪая╕П рдХрд╛рдо рдЭрд╛рд▓реЗ, рдкрдг рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╛рд╣реА";
        }
        data["рдЯреАрдк"] = remark;

        fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.result === "success") {
              document.getElementById("status").textContent =
                "тЬЕ рдорд╛рд╣рд┐рддреА Sheet рдордзреНрдпреЗ рдЬрддрди рдЭрд╛рд▓реА!";
              showPopup();
              setTimeout(() => redirectToDashboard(), 2000);
              form.reset();
              const today = new Date();
              const formattedDate = today.toISOString().split("T")[0];
              document.getElementById("todayDate").value = formattedDate;
              hideAndClearExtraFields();
              setTimeout(
                () => document.getElementById("todayDate").focus(),
                200
              );
              loadDataFromSheet();
            } else {
              document.getElementById("status").textContent =
                "тЪая╕П server рдиреЗ error рджрд┐рд▓рд╛.";
            }
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("status").textContent =
              "тЪая╕П рдПрд░рд░: рдорд╛рд╣рд┐рддреА рдЬрддрди рдЭрд╛рд▓реА рдирд╛рд╣реА!";
          });
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        const form = document.getElementById("mainForm");
        form.reset();
        const today = new Date();
        const formattedDate = today.toISOString().split("T")[0];
        document.getElementById("todayDate").value = formattedDate;
        hideAndClearExtraFields();
        document.getElementById("status").innerHTML = "тЩ╗я╕П рдлреЙрд░реНрдо рд░реАрд╕реЗрдЯ рдЭрд╛рд▓рд╛.";
        setTimeout(() => document.getElementById("todayDate").focus(), 200);
      });

      function updateSummary(filtered) {
        if (filtered.length === 0) {
          document.getElementById("summaryDiv").innerHTML = "рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА";
          return;
        }

        let group = {};
        filtered.forEach((r) => {
          const machine = r["рдорд╢реАрди"] || "Unknown";
          const key = machine;
          const total = toNumber(r["Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)"]);
          const diesel = toNumber(r["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"]);
          let type = r["рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░"] || "";

          if (!type) {
            if (
              machine.includes("рдЬреЗрд╕реАрдмреА") ||
              machine.includes("рд╕реЕрдиреА") ||
              machine.includes("рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА") ||
              machine.includes("рдбреЛрдЭрд░")
            ) {
              type = "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░";
            } else if (machine.includes("рдЯрд┐рдкрд░")) {
              type = "рдЯрд┐рдкрд░";
            } else if (machine.includes("рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░")) {
              type = "рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░";
            } else if (machine.includes("рдпреБрдЯрд┐рд▓рд┐рдЯреА")) {
              type = "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ";
            }
          }

          if (!group[key]) {
            group[key] = {
              totalHours: 0,
              totalDiesel: 0,
              machine,
              operators: new Set(),
              type,
            };
          }
          group[key].totalHours += total;
          group[key].totalDiesel += diesel;
          if (r["рдЪрд╛рд▓рдХ"]) group[key].operators.add(r["рдЪрд╛рд▓рдХ"]);
        });

        let entries = Object.values(group).map((g) => {
          let avg = 0;
          if (g.type === "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░") {
            if (g.totalHours > 0) avg = g.totalDiesel / g.totalHours;
          } else {
            if (g.totalDiesel > 0) avg = g.totalHours / g.totalDiesel;
          }
          return {
            machine: g.machine,
            operators: Array.from(g.operators).join(", "),
            type: g.type,
            totalHours: g.totalHours,
            totalDiesel: g.totalDiesel,
            avgDiesel: avg,
          };
        });

        let machineEntries = entries.filter(
          (e) => e.type === "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░" && e.avgDiesel > 0
        );
        let vehicleEntries = entries.filter(
          (e) => e.type !== "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░" && e.avgDiesel > 0
        );

        let bestMachine = null,
          worstMachine = null;
        if (machineEntries.length) {
          bestMachine = machineEntries.reduce((a, b) =>
            a.avgDiesel < b.avgDiesel ? a : b
          );
          worstMachine = machineEntries.reduce((a, b) =>
            a.avgDiesel > b.avgDiesel ? a : b
          );
        }

        let bestVehicle = null,
          worstVehicle = null;
        if (vehicleEntries.length) {
          bestVehicle = vehicleEntries.reduce((a, b) =>
            a.avgDiesel > b.avgDiesel ? a : b
          );
          worstVehicle = vehicleEntries.reduce((a, b) =>
            a.avgDiesel < b.avgDiesel ? a : b
          );
        }

        let html = `
    <h3 class="summary-heading">ЁЯУК рдорд╢реАрди рдХрд╛рдордЧрд┐рд░реАрдЪрд╛ рд╕рд╛рд░рд╛рдВрд╢</h3>
    <div class="table-container">
      <table border="1" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>Category</th>
            <th>Machine/Vehicle</th>
            <th>Operators</th>
            <th>Average</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ЁЯЪЬ рд╕рд░реНрд╡рд╛рдд рдЪрд╛рдВрдЧрд▓реЗ Machine Average</td>
            <td>${bestMachine ? bestMachine.machine : "-"}</td>
            <td>${bestMachine ? bestMachine.operators : "-"}</td>
            <td>${
              bestMachine ? bestMachine.avgDiesel.toFixed(2) + " L/hr" : "-"
            }</td>
            <td>ЁЯСП рдЕрднрд┐рдирдВрджрди !</td>
          </tr>
          <tr>
            <td>ЁЯЪЪ рд╕рд░реНрд╡рд╛рдд рдЪрд╛рдВрдЧрд▓реЗ Vehicle Average</td>
            <td>${bestVehicle ? bestVehicle.machine : "-"}</td>
            <td>${bestVehicle ? bestVehicle.operators : "-"}</td>
            <td>${
              bestVehicle ? bestVehicle.avgDiesel.toFixed(2) + " Km/L" : "-"
            }</td>
            <td>ЁЯСП рдЕрднрд┐рдирдВрджрди !</td>
          </tr>
          <tr>
            <td>ЁЯЪЬ рд╕рд░реНрд╡рд╛рдд рдЦрд░рд╛рдм Machine Average</td>
            <td>${worstMachine ? worstMachine.machine : "-"}</td>
            <td>${worstMachine ? worstMachine.operators : "-"}</td>
            <td>${
              worstMachine ? worstMachine.avgDiesel.toFixed(2) + " L/hr" : "-"
            }</td>
            <td>тЪая╕П рдЦрдмрд░рджрд╛рд░реА рдШреНрдпрд╛</td>
          </tr>
          <tr>
            <td>ЁЯЪЪ рд╕рд░реНрд╡рд╛рдд рдЦрд░рд╛рдм Vehicle Average</td>
            <td>${worstVehicle ? worstVehicle.machine : "-"}</td>
            <td>${worstVehicle ? worstVehicle.operators : "-"}</td>
            <td>${
              worstVehicle ? worstVehicle.avgDiesel.toFixed(2) + " Km/L" : "-"
            }</td>
            <td>тЪая╕П рд╕реБрдзрд╛рд░рдгрд╛ рдХрд░рдгреЗ</td>
          </tr>
        </tbody>
      </table>
    </div>`;

        document.getElementById("summaryDiv").innerHTML = html;
      }

      function updateDashboard() {
        let machineFilter = document.getElementById("dashMachine").value;
        let startDate = document.getElementById("startDate").value;
        let endDate = document.getElementById("endDate").value;

        fetch(
          "https://opensheet.elk.sh/1DvrWe99U3qLPm0Zko77zZfPjnbiT3PwEaRY5dP2t820/Sheet1"
        )
          .then((res) => res.json())
          .then((data) => {
            let filteredAll = data.filter((r) => {
              if (startDate && endDate) {
                let d = new Date(r["рджрд┐рдирд╛рдВрдХ"]);
                return d >= new Date(startDate) && d <= new Date(endDate);
              }
              return true;
            });

            let filtered = filteredAll.filter((r) => {
              return !machineFilter || r["рдорд╢реАрди"] === machineFilter;
            });

            updateSummary(filteredAll);

            let totalHours = 0,
              totalDiesel = 0;
            filtered.forEach((r) => {
              totalHours += toNumber(r["Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)"]);
              totalDiesel += toNumber(r["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"]);
            });

            let machineName = machineFilter
              ? machineFilter
              : filtered[0]
              ? filtered[0]["рдорд╢реАрди"]
              : "N/A";
            const isVehicle = Object.prototype.hasOwnProperty.call(
              vehicleRates,
              machineName
            );
            const workUnit = isVehicle ? "рдХрд┐рдореА" : "рддрд╛рд╕";

            document.getElementById(
              "dashTotal"
            ).textContent = `тП▒ ${totalHours.toFixed(
              1
            )} ${workUnit}, тЫ╜ ${totalDiesel.toFixed(1)} рд▓рд┐рдЯрд░`;

            document.getElementById("dashCount").textContent = filtered.length;

            let allowed = 0;
            if (
              machineName &&
              Object.prototype.hasOwnProperty.call(vehicleRates, machineName)
            ) {
              allowed = totalHours / vehicleRates[machineName];
            } else {
              let rate = getRateForMachine(machineName);
              allowed = rate * totalHours;
            }

            let tbody = document.querySelector("#dashTable tbody");
            tbody.innerHTML = "";
            if (filtered.length) {
              const remark = totalDiesel <= allowed ? "рдпреЛрдЧреНрдп" : "рдЬрд╛рд╕реНрдд";
              const remarkClass = totalDiesel <= allowed ? "green" : "red";

              let row = document.createElement("tr");
              row.innerHTML = `
          <td>${machineName}</td>
          <td>${totalHours.toFixed(1)} ${workUnit}</td>
          <td>${totalDiesel.toFixed(1)} рд▓рд┐рдЯрд░</td>
          <td>${allowed.toFixed(1)} рд▓рд┐рдЯрд░</td>
          <td class="${remarkClass}">${remark}</td>`;
              tbody.appendChild(row);
            } else {
              tbody.innerHTML = `<tr><td colspan="5">рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА</td></tr>`;
            }

            let labels = [];
            let allowedData = [];
            let actualData = [];
            if (filtered.length) {
              labels = [machineName];
              allowedData = [allowed.toFixed(1)];
              actualData = [totalDiesel.toFixed(1)];
            }
            if (chart) chart.destroy();
            chart = new Chart(document.getElementById("consumptionGraph"), {
              type: "bar",
              data: {
                labels,
                datasets: [
                  {
                    label: `Allowed (рд▓рд┐рдЯрд░)`,
                    data: allowedData,
                    backgroundColor: "rgba(54,162,235,0.6)",
                  },
                  {
                    label: `Actual (рд▓рд┐рдЯрд░)`,
                    data: actualData,
                    backgroundColor: "rgba(255,99,132,0.6)",
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: { legend: { position: "top" } },
              },
            });
          });
      }

      document.getElementById("dashFetchBtn").addEventListener("click", (e) => {
        e.preventDefault();
        updateDashboard();
      });

      function loadDataFromSheet() {
        fetch(
          "https://opensheet.elk.sh/1DvrWe99U3qLPm0Zko77zZfPjnbiT3PwEaRY5dP2t820/Sheet1"
        )
          .then((res) => res.json())
          .then((data) => {
            records = data;
            updateDashboard();
          })
          .catch((err) => console.error("рд▓реЛрдбрд┐рдВрдЧрдордзреНрдпреЗ рдЕрдбрдЪрдг:", err));
      }

      function redirectToDashboard() {
        document.getElementById("formPage").style.display = "none";
        document.getElementById("dashboardPage").style.display = "block";
        updateDashboard();
      }

      function showFormPage() {
        document.getElementById("dashboardPage").style.display = "none";
        document.getElementById("formPage").style.display = "block";
        document.getElementById("status").textContent =
          "ЁЯЫИ рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рднрд░реВрди 'рд╕рдмрдорд┐рдЯ рдХрд░рд╛' рджрд╛рдмрд╛.";
        document.getElementById("mainForm").reset();
        const today = new Date();
        document.getElementById("todayDate").value = today
          .toISOString()
          .split("T")[0];
      }

      function showPopup(
        message = "рддреБрдордЪреА рдорд╛рд╣рд┐рддреА Google Sheet рдордзреНрдпреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдЭрд╛рд▓реА рдЖрд╣реЗ."
      ) {
        const popup = document.getElementById("successPopup");
        if (!popup) return;

        const p = popup.querySelector(".popup-content p");
        if (p) p.textContent = message;

        const tick = popup.querySelector(".checkmark");
        if (tick) {
          tick.classList.remove("draw");
          void tick.offsetWidth;
          tick.classList.add("draw");
        }

        popup.classList.add("show");
        popup.setAttribute("aria-hidden", "false");

        setTimeout(() => {
          popup.classList.remove("show");
          popup.setAttribute("aria-hidden", "true");
        }, 2000);
      }

      function showAdminLogin() {
        const code = prompt("ЁЯФС Admin Code рдЯрд╛рдХрд╛:");
        if (code === ADMIN_CODE) {
          document.getElementById("formPage").style.display = "none";
          document.getElementById("dashboardPage").style.display = "none";
          document.getElementById("adminPage").style.display = "block";
        } else {
          alert("тЭМ рдЪреБрдХреАрдЪрд╛ рдХреЛрдб. рдкрд░рдд рдкреНрд░рдпрддреНрди рдХрд░рд╛.");
        }
      }

      function backToForm() {
        document.getElementById("adminPage").style.display = "none";
        document.getElementById("formPage").style.display = "block";
      }

      function generateMonthlyReport() {
        const month = document.getElementById("reportMonth").value;
        if (!month) {
          document.getElementById("monthlyReportStatus").textContent =
            "тЪая╕П рдХреГрдкрдпрд╛ рдорд╣рд┐рдирд╛ рдирд┐рд╡рдбрд╛!";
          return;
        }

        document.getElementById("monthlyReportStatus").textContent =
          "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ... рдХреГрдкрдпрд╛ рдереЛрдбрд╛ рд╡реЗрд│ рд╡рд╛рдЯ рдкрд╣рд╛ (рез-реи рдорд┐рдирд┐рдЯреЗ)";
        document.getElementById("monthlyReportLink").innerHTML = "";

        // Use Google Apps Script URL with /exec and form submission
        const scriptURL =
          "https://script.google.com/macros/s/AKfycbzT-vob4JQLy3ia3Kt26kX9XPOFd0-90zoucFXnLrFWEaO6Vitxpw-k_2SdEi8oIZiPww/exec";

        // Create a form and submit it (bypasses CORS)
        const form = document.createElement("form");
        form.method = "POST";
        form.action = scriptURL;
        form.target = "_hiddenFrame";

        // Add action field
        const actionInput = document.createElement("input");
        actionInput.type = "hidden";
        actionInput.name = "action";
        actionInput.value = "generateMonthlyReport";
        form.appendChild(actionInput);

        // Add month field
        const monthInput = document.createElement("input");
        monthInput.type = "hidden";
        monthInput.name = "month";
        monthInput.value = month;
        form.appendChild(monthInput);

        // Create hidden iframe to handle response
        const iframe = document.createElement("iframe");
        iframe.name = "_hiddenFrame";
        iframe.style.display = "none";
        document.body.appendChild(iframe);

        // Handle response
        iframe.onload = function () {
          try {
            const response = JSON.parse(
              iframe.contentDocument.body.textContent
            );
            if (response.result === "success") {
              document.getElementById("monthlyReportStatus").textContent =
                "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛ рдЖрдгрд┐ рдИрдореЗрд▓ рдХреЗрд▓рд╛ рдЧреЗрд▓рд╛!";
              document.getElementById(
                "monthlyReportLink"
              ).innerHTML = `<div style="margin-top: 10px; padding: 12px; background: #f0f8f0; border-radius: 8px; border: 1px solid #4caf50;">
            <p style="margin: 0 0 8px 0; font-weight: bold; color: #2e7d32;">ЁЯУз рдорд╣рд┐рдирд╛ ${month} рдЪрд╛ рд░рд┐рдкреЛрд░реНрдЯ рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛</p>
            <p class="small" style="margin: 4px 0;">тЬЕ PDF рд░рд┐рдкреЛрд░реНрдЯ рддреБрдордЪреНрдпрд╛ Google Drive рдордзреНрдпреЗ рд╕реЗрд╡реНрд╣ рдЭрд╛рд▓рд╛ рдЖрд╣реЗ</p>
            <p class="small" style="margin: 4px 0;">ЁЯУи рд░рд┐рдкреЛрд░реНрдЯ рдЦрд╛рд▓реАрд▓ рдИрдореЗрд▓ рдкрддреНрддреНрдпрд╛рд╡рд░ рдкрд╛рдард╡рд▓рд╛ рдЧреЗрд▓рд╛ рдЖрд╣реЗ:</p>
            <p class="small" style="margin: 4px 0; font-weight: bold;">rohitppatil37@gmail.com</p>
            <p class="small" style="margin: 4px 0; font-weight: bold;">rohit15437patil@gmail.com</p>
           </div>`;
            } else {
              document.getElementById("monthlyReportStatus").textContent =
                "тЭМ рддреНрд░реБрдЯреА: " + (response.error || "рдЕрдЬреНрдЮрд╛рдд рддреНрд░реБрдЯреА");
            }
          } catch (e) {
            document.getElementById("monthlyReportStatus").textContent =
              "тЭМ рдкреНрд░рддрд┐рд╕рд╛рдж рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛рдирд╛ рддреНрд░реБрдЯреА";
          }

          // Clean up
          document.body.removeChild(form);
          document.body.removeChild(iframe);
        };

        document.body.appendChild(form);
        form.submit();
      }

      function generateQuarterlyReport() {
        const year = document.getElementById("quarterYear").value;
        const quarter = document.getElementById("quarterSelect").value;
        if (!year || !quarter) {
          document.getElementById("quarterlyReportStatus").textContent =
            "тЪая╕П рдХреГрдкрдпрд╛ рд╡рд░реНрд╖ рдЖрдгрд┐ Quarter рдирд┐рд╡рдбрд╛!";
          return;
        }
        document.getElementById("quarterlyReportStatus").textContent =
          "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ...";
        setTimeout(() => {
          document.getElementById("quarterlyReportStatus").textContent =
            "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛!";
          document.getElementById(
            "quarterlyReportLink"
          ).innerHTML = `<a href="https://docs.google.com/spreadsheets/d/YYYY/export?format=pdf" target="_blank">ЁЯУе Download Quarterly Report (${year} ${quarter})</a>`;
        }, 1500);
      }

      function generateExpenseReport() {
        const year = document.getElementById("expenseYear").value;
        const quarter = document.getElementById("expenseQuarter").value;
        if (!year || !quarter) {
          document.getElementById("expenseReportStatus").textContent =
            "тЪая╕П рдХреГрдкрдпрд╛ рд╡рд░реНрд╖ рдЖрдгрд┐ Quarter рдирд┐рд╡рдбрд╛!";
          return;
        }
        document.getElementById("expenseReportStatus").textContent =
          "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ...";
        setTimeout(() => {
          document.getElementById("expenseReportStatus").textContent =
            "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛!";
          document.getElementById(
            "expenseReportLink"
          ).innerHTML = `<a href="https://docs.google.com/spreadsheets/d/ZZZZ/export?format=pdf" target="_blank">ЁЯУе Download Expense Report (${year} ${quarter})</a>`;
        }, 1500);
      }
    </script>
  </body>
</html>
