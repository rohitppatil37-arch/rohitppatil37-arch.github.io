<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ЁЯУЭ рдорд╛рддреАрдХрд╛рдо рдкреНрд░рдЧрддреА тАФ рдорд╢реАрди</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --card-radius:14px;
      --glass-bg: rgba(255,255,255,0.6);
      --accent1: #06b6d4;
      --accent2: #7c3aed;
      --muted: #5b6570;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Noto Sans Devanagari", system-ui, sans-serif;
      background: linear-gradient(135deg,#e6f0ff 0%, #f7fbff 60%);
      padding:28px;
      color:#0b1723;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px;}
    @media(max-width:1000px){ .wrap{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.6));
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow: 0 10px 30px rgba(11,20,35,0.08);
      border:1px solid rgba(11,20,35,0.04);
      backdrop-filter: blur(6px) saturate(120%);
    }
    .hero{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:24px}
    h1{margin:0;font-size:18px}
    p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}

    form .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(max-width:720px){ form .grid{grid-template-columns:1fr} }
    label{display:block;font-weight:700;font-size:13px;margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="time"], select, textarea, input[type="date"]{
      width:100%; padding:10px 12px;border-radius:10px;border:1px solid rgba(11,20,35,0.06); background:rgba(255,255,255,0.95); font-size:14px; outline:none;
      transition: box-shadow .12s, transform .08s;
    }
    input:focus, select:focus, textarea:focus{box-shadow:0 8px 20px rgba(99,102,241,0.12); transform:translateY(-2px); border-color: rgba(99,102,241,0.45);}
    .full{grid-column:1/-1}

    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800;color:white;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 10px 28px rgba(99,102,241,0.14)}
    .btn.ghost{background:transparent;color:#0b1723;border:1px solid rgba(11,20,35,0.06)}
    .small{font-size:13px;color:var(--muted)}

    .dash-col{display:flex;flex-direction:column;gap:12px;position:sticky;top:20px}
    .dash-card{padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.65),rgba(255,255,255,0.55));border:1px solid rgba(11,20,35,0.04)}
    .big{font-size:20px;font-weight:900;color:#0b3a66}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid rgba(11,20,35,0.06);padding:8px;text-align:center;font-size:13px}
    th{background:rgba(11,20,35,0.04)}
    .green{color:green;font-weight:700}
    .red{color:red;font-weight:700}
    footer.note{margin-top:10px;font-size:12px;color:var(--muted)}
    .chart-wrap{overflow-x:auto}
.glow {
  box-shadow: 0 0 12px rgba(0, 200, 0, 0.6);
  transition: box-shadow 0.5s ease-out;
}
/* ---------- Success Popup ---------- */
.popup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  justify-content: center;
  align-items: center;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.25s ease, visibility 0.25s ease;
  z-index: 9999;
}
.popup.show {
  visibility: visible;
  opacity: 1;
}
.popup-content {
  background: #ffffff;
  padding: 20px 26px;
  border-radius: 12px;
  text-align: center;
  max-width: 360px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  transform: scale(0.8);
  opacity: 0;
  transition: all 0.3s ease;
}
.popup.show .popup-content {
  transform: scale(1);
  opacity: 1;
}
.popup-content h2 { margin:0 0 8px; color: #0b8a2f; font-size:18px; }
.popup-content p  { margin:0; font-size:14px; color:#223344; }
/* --- Success Check Animation --- */
.checkmark-circle {
  width: 80px;
  height: 80px;
  position: relative;
  display: inline-block;
  vertical-align: top;
  margin-bottom: 12px;
}
.checkmark-circle .background {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #4caf50;
  position: absolute;
  top: 0;
  left: 0;
}
.checkmark {
  width: 28px;
  height: 56px;
  border-right: 6px solid white;
  border-bottom: 6px solid white;
  transform: rotate(45deg) scale(0.5);
  position: absolute;
  top: 12px;
  left: 24px;
  opacity: 0;
}
.checkmark.draw {
  animation: checkmark 0.6s ease forwards;
  animation-delay: 0.2s;
}
@keyframes checkmark {
  from { opacity: 0; transform: rotate(45deg) scale(0.5); }
  to   { opacity: 1; transform: rotate(45deg) scale(1); }
}

/* Summary heading style */
.summary-heading {
  margin: 10px 0;
  text-align: center;
  color: #0b3a66;
  font-size: 16px;
  font-weight: 800;
}

/* Responsive table wrapper for summary */
.table-container {
  width: 100%;
  overflow-x: auto;   /* рдореЛрдмрд╛рдИрд▓рд╡рд░ scroll рдпреЗрдИрд▓ */
  -webkit-overflow-scrolling: touch;
  padding-bottom: 8px;
}

.table-container table {
  min-width: 400px;   /* рдЯреЗрдмрд▓рдЪрд╛ рдЖрдХрд╛рд░ fix */
}
  .mic-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:1px solid rgba(11,20,35,0.06);background:transparent;cursor:pointer;margin-left:8px}
  .mic-btn.recording{box-shadow:0 0 10px rgba(99,102,241,0.25);background:rgba(99,102,241,0.06)}
  .mic-indicator{font-size:12px;color:#0b3a66;margin-left:8px}
</style>
</head>
<body>

<div id="formPage" class="wrap">
  <div class="card">
    <div class="hero">
      <div class="logo">рдХ</div>
      <div>
        <h1>ЁЯУЭ рдорд╛рддреАрдХрд╛рдо рдкреНрд░рдЧрддреА тАФ рдорд╢реАрди</h1>
        <p class="lead">рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рдорд░рд╛рдареАрдд рдиреАрдЯ рдкрдгреЗ рднрд░рд╛рд╡реА</p>
      </div>
    </div>

    <!-- --- FORM --- -->
    <form id="mainForm" autocomplete="off" novalidate>
      <div class="grid">
        <div>
          <label for="todayDate">ЁЯУЕ рдЖрдЬрдЪрд╛ рджрд┐рдирд╛рдВрдХ</label>
          <input id="todayDate" type="date" required>
        </div>

        <div>
          <label for="workType">ЁЯОЫ рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
          <select id="workType" required>
            <option value="" disabled selected>рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛...</option>
            <option value="рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛">рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛</option>
            <option value="рдорд╛рддреАрдХрд╛рдо">рдорд╛рддреАрдХрд╛рдо</option>
          </select>
          <div class="hint">рдкреНрд░рдХрд▓реНрдкрд╛рдЪреНрдпрд╛ рдпрд╛рджреАрд╕рд╛рдареА рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛</div>
        </div>

        <div>
          <label for="projectName">ЁЯПЧ рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡</label>
          <select id="projectName" required>
            <option value="" disabled selected>рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡ рдирд┐рд╡рдбрд╛...</option>
          </select>
        </div>
<div>
  <label for="machineType">тЪЩя╕П рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
  <select id="machineType" required>
  <option value="" disabled selected>рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛...</option>
  <option value="рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░">рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░</option>
  <option value="рдЯрд┐рдкрд░">рдЯрд┐рдкрд░</option>
  <option value="рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░">рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░</option>
  <option value="рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ">рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ</option>
</select>
</div>

        <div>
  <label for="driver">ЁЯС╖ рдЪрд╛рд▓рдХрд╛рдЪреЗ рдирд╛рд╡</label>
  <select id="driver" required>
    <option value="" disabled selected>рдЪрд╛рд▓рдХ рдирд┐рд╡рдбрд╛...</option>
    <option>рд░рд╛рдЬреЗрдВрджреНрд░ рдирд╛рдЧреВ рдЬрд╛рдзрд╡</option>
    <option>рд░рд╛рдЬреЗрдВрджреНрд░ рдХрджрдо</option>
    <option>рдирд┐рд▓реЗрд╢ рдорд╛рд░реБрддреА рдЪрд╡реНрд╣рд╛рдг</option>
    <option>рдореБрдмрд╛рд░рдХ рдЗрд╕реНрдорд╛рдИрд▓ рд╣рдбрдкреЛрд▓рдХрд░</option>
    <option>рд░рд╡реАрдВрджреНрд░ рддреБрдХрд╛рд░рд╛рдо рджреЗрд╕рд╛рдИ</option>
    <option>рд╕реБрд░реЗрд╢ рдкрд╛рдВрдбреБрд░рдВрдЧ рдмрд╛рдЧрд╡реЗ</option>
    <option>рд╕реБрд░реЗрд╢ рдирд╛рд░рд╛рдпрдг рдирд┐рдВрдмрд╛рд│рдХрд░</option>
    <option>рднрд╛рдЧрд╡рдд рдореЛрд╣рди рд╕реБрд│</option>
    <option>рдореЛрд╣рд╕реАрди рдЗрдХреНрдмрд╛рд▓ рд╕рдпреНрдпрдж</option>
    <option>рд╕рд░рдлрд░рд╛рдЭ рдЕрдлрд╕рд╛рд░ рд╢реЗрдЦ</option>
  </select>
</div>


        <div>
  <label for="machine">ЁЯУЛ рд╕рдпрдВрддреНрд░рд╛рдЪреЗ рдирд╛рд╡</label>
  <select id="machine" required>
    <option value="" disabled selected>рд╕рдпрдВрддреНрд░ рдирд┐рд╡рдбрд╛...</option>
  </select>
</div>


        <div class="full">
  <label for="dieselQty">тЫ╜ рдЖрдЬ рдХрд┐рддреА рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ (рд▓рд┐рдЯрд░ рдордзреНрдпреЗ)</label>
  <input id="dieselQty" type="number" min="0" step="0.1" placeholder="рдЙрджрд╛. 25.5 рдЖрдгрд┐ рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╕реЗрд▓ рддрд░ 0 рд▓рд┐рд╣рд╛" required >
  <div class="hint">рджрд╢рд╛рдВрд╢ рд╕реНрд╡реАрдХрд╛рд░рд▓реЗ рдЬрд╛рддреАрд▓ (рдЙрджрд╛. 12.5)</div>
</div>

<div>
  <label for="dieselTime">ЁЯХТ рдбрд┐рдЭреЗрд▓ рднрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
  <input id="dieselTime" type="time" placeholder="рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╕реЗрд▓ рддрд░ рд╣рд╛ рдкреНрд░рд╢реНрди рд╡рдЧрд│рд╛" required>
</div>

<div>
  <label for="dieselReading">ЁЯУЯ рдбрд┐рдЭреЗрд▓ рднрд░рдгреНрдпрд╛рд╡реЗрд│реА Dashboard Reading (рддрд╛рд╕/km)</label>
  <input id="dieselReading" type="number" placeholder="рдЙрджрд╛. 12345" required>
</div>

<div>
  <label for="startReading">тЦ╢я╕П рдХрд╛рдо рд╕реБрд░реВ рдХрд░рддрд╛рдирд╛рдЪреЗ Dashboard Reading (рддрд╛рд╕/km)</label>
  <input id="startReading" type="number" placeholder="рдЙрджрд╛. 500 рдХрд┐рдВрд╡рд╛ 12000">
</div>

<div>
  <label for="endReading">тП╣ рдХрд╛рдо рдерд╛рдВрдмрд╡рддрд╛рдирд╛рдЪреЗ Dashboard Reading (рддрд╛рд╕/km)</label>
  <input id="endReading" type="number" placeholder="рдЙрджрд╛. 510 рдХрд┐рдВрд╡рд╛ 12050">
</div>

<div class="full">
  <label for="totalHoursReading">тЪб Dashboard рдиреБрд╕рд╛рд░ рдЖрдЬрдЪреЗ рдПрдХреВрдг рддрд╛рд╕ / рдХрд┐рдореА</label>
  <input id="totalHoursReading" type="text" placeholder="ЁЯФД рдЧрдгрдирд╛ рдЖрдкреЛрдЖрдк рд╣реЛрдИрд▓" readonly>
  <div class="hint">endReading - startReading = рдЖрдЬрдЪрд╛ рдПрдХреВрдг рддрд╛рд╕ / рдХрд┐рдореА</div>
</div>

<!-- Merged FromтЖТTo + TripCount field (replaces extraFields + tipperTripsField) -->
<div id="locationWrapper" class="full" style="display:none">
  <label for="locationFromTo">ЁЯУН From тЖТ To (рдЙрджрд╛. "рд╕рд╛рдЗрдЯ A - рдбрдВрдкрдпрд╛рд░реНрдб")</label>
  <div style="display:flex;align-items:center;gap:8px">
    <input id="locationFromTo" type="text" placeholder="рдЙрджрд╛. рд╕рд╛рдЗрдЯ A - рдбрдВрдкрдпрд╛рд░реНрдб" style="flex:1" />
    <button type="button" id="micLocation" class="mic-btn" title="рд╡реНрд╣реЙрдЗрд╕рдиреЗ рднрд░рд╛">ЁЯОЩя╕П</button>
    <span id="locIndicator" class="mic-indicator"></span>
  </div>
  <div class="hint">рдард┐рдХрд╛рдгрд╛рд╕рд╛рдареА рдмреЛрд▓рд╛ тАФ \"рд╕рд╛рдЗрдЯ A рддреЗ рдбрдВрдкрдпрд╛рд░реНрдб\" рдХрд┐рдВрд╡рд╛ \"рд╕рд╛рдЗрдЯ A - рдбрдВрдкрдпрд╛рд░реНрдб\".</div>

  <label for="tripCount" style="margin-top:8px">ЁЯЪЫ рдЯреНрд░рд┐рдк рд╕рдВрдЦреНрдпрд╛ (рдЙрджрд╛. 5)</label>
  <input id="tripCount" type="number" min="0" placeholder="рдЙрджрд╛. 5" />
  <div class="hint">рд╡реНрд╣реЙрдЗрд╕ рдЖрдпрдирдкреБрдЯрдиреЗ рд╕рдВрдЦреНрдпрд╛ рд╕рд╛рдкрд░рд▓реНрдпрд╛рд╕ auto-fill рд╣реЛрдИрд▓; рдирд╕реЗрд▓ рддрд░ рдЗрдереЗ рднрд░рд╛.</div>
</div>





        <div>
          <label for="shift1Start">ЁЯМЕ рдкрд╣рд┐рд▓рд╛ Shift рд╕реБрд░реВ рдХрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
          <input id="shift1Start" type="time">
        </div>
        <div>
          <label for="shift1End">ЁЯМЗ рдкрд╣рд┐рд▓рд╛ Shift рдерд╛рдВрдмрд╡рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
          <input id="shift1End" type="time">
        </div>

        <div>
          <label for="shift2Start">ЁЯМЩ рджреБрд╕рд░рд╛ Shift рд╕реБрд░реВ рдХрд░рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
          <input id="shift2Start" type="time">
        </div>
        <div>
          <label for="shift2End">ЁЯММ рджреБрд╕рд░рд╛ Shift рдерд╛рдВрдмрд╡рдгреНрдпрд╛рдЪреА рд╡реЗрд│</label>
          <input id="shift2End" type="time">
        </div>

        <div class="full">
          <label for="totalShiftHours">ЁЯХУ рд╢рд┐рдлреНрдЯрдиреБрд╕рд╛рд░ рдПрдХреВрдг рдХрд╛рдорд╛рдЪреЗ рддрд╛рд╕</label>
          <input id="totalShiftHours" type="text" placeholder="ЁЯФД рдЧрдгрдирд╛ рдЖрдкреЛрдЖрдк рд╣реЛрдИрд▓" readonly>
        </div>
      </div>

      <div class="actions full">
  <button type="button" class="btn" id="submitBtn">тЬЕ рд╕рдмрдорд┐рдЯ рдХрд░рд╛</button>
  <button type="button" class="btn" id="resetBtn">тЩ╗я╕П рд░реАрд╕реЗрдЯ</button>
  <button type="button" class="btn" onclick="redirectToDashboard()">ЁЯУК Dashboard рдкрд╛рд╣рд╛</button>
  <button type="button" class="btn" onclick="showAdminLogin()">ЁЯФС Admin Login</button>
</div>

</div>

<!-- тЬЕ рдиреЛрдЯ рдЖрддрд╛ live clock рдЪреНрдпрд╛ рд╡рд░ -->
<div class="small" style="margin-top:8px" id="status">тЪая╕П рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рднрд░реВрди 'рд╕рдмрдорд┐рдЯ рдХрд░рд╛' рджрд╛рдмрд╛.</div>

<!-- тЬЕ live clock рдЦрд╛рд▓реА рдареЗрд╡рд▓реЗрд▓рдВ -->
<div class="small" style="margin-top:12px; text-align:center">
  ЁЯХШ рд╡реЗрд│: <span id="nowStamp">тАФ</span>
</div>


    </form>
    </div> <!-- end .card -->
</div> <!-- end #formPage -->

  <!-- PAGE 2: DASHBOARD -->
<div id="dashboardPage" class="wrap" style="display:none">
  <div class="actions full" style="justify-content:center; margin-top:16px">
  <button type="button" class="btn" onclick="showFormPage()">ЁЯУЭ рдкрд░рдд Form рдкрд╛рд╣рд╛</button>
</div>


  <!-- --- DASHBOARD --- -->
<div class="dash-col">
  <div id="summaryDiv" class="dash-card card" style="margin-top:16px;">
    ЁЯФД рдЧрдгрдирд╛ рдХрд░рдд рдЖрд╣реЗ...
  </div>
  <div class="dash-card card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="small">ЁЯУК рдорд╛рдЭрд╛ рдорд╢реАрди рдбреЕрд╢рдмреЛрд░реНрдб</div>
        <div style="font-weight:800;margin-top:8px">рдлрдХреНрдд рдирд┐рд╡рдбрд▓реЗрд▓реНрдпрд╛ рдорд╢реАрдирдЪреА рдорд╛рд╣рд┐рддреА</div>
      </div>
      <div style="font-size:22px;color:#0b3a66;font-weight:900">тЫ╜</div>
    </div>

    <!-- тЬЕ Step 1: Machine Type -->
    <div style="margin-top:12px">
      <label>тЪЩя╕П рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░</label>
      <select id="dashMachineType">
        <option value="">--- рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛ ---</option>
        <option value="рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░">рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░</option>
        <option value="рдЯрд┐рдкрд░">рдЯрд┐рдкрд░</option>
        <option value="рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░">рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░</option>
        <option value="рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ">рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ</option>
      </select>
    </div>

    <!-- тЬЕ Step 2: Machine / Vehicle Name -->
    <div style="margin-top:12px">
      <label>ЁЯУЛ рдорд╢реАрди / рд╡рд╛рд╣рди</label>
      <select id="dashMachine">
        <option value="">--- рдорд╢реАрди рдирд┐рд╡рдбрд╛ ---</option>
      </select>
    </div>

    <!-- тЬЕ Step 3: Date Range -->
    <div style="margin-top:12px">
      <label>ЁЯУЖ рд╕реБрд░реБрд╡рд╛рддреАрдЪреА рддрд╛рд░реАрдЦ</label>
      <input type="date" id="startDate">
    </div>
    <div style="margin-top:8px">
      <label>ЁЯУЖ рд╢реЗрд╡рдЯрдЪреА рддрд╛рд░реАрдЦ</label>
      <input type="date" id="endDate">
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" id="dashFetchBtn">ЁЯФБ рдЕрдкрдбреЗрдЯ</button>
    </div>

    <hr style="border:none;border-top:1px dashed rgba(11,20,35,0.06);margin:12px 0">

    <div class="small">ЁЯЧУ рдХрд╛рд▓рд╛рд╡рдзреА: рдЪрд╛рд▓реВ рдорд╣рд┐рдиреНрдпрд╛рдЪреНрдпрд╛ 1 рддрд╛рд░рдЦреЗрдкрд╛рд╕реВрди рдЖрдЬрдкрд░реНрдпрдВрдд</div>
    <div class="big" id="dashTotal">тП│ рд▓реЛрдб рдХрд░рдд рдЖрд╣реЗ...</div>
    <div class="small" style="margin-top:8px">ЁЯз╛ рдиреЛрдВрджреА: <span id="dashCount">0</span></div>
    
    <div class="table-container">
      <table id="dashTable" border="1" style="width:100%; margin-top:20px;">
        <thead>
          <tr>
            <th>рдорд╢реАрди</th>
            <th>рдХрд╛рдо (рддрд╛рд╕ / рдХрд┐рдореА)</th>
            <th>Actual рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)</th>
            <th>Allowed (рд▓рд┐рдЯрд░)</th>
            <th>рдЯреАрдк</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="dash-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="small">тЪЦя╕П Actual vs Allowed</div><div style="font-weight:800;margin-top:6px">рдорд╢реАрди рдиреБрд╕рд╛рд░ рддреБрд▓рдирд╛</div></div>
        <div style="font-size:20px">ЁЯУИ</div>
      </div>
      <div class="chart-wrap" style="margin-top:12px">
        <canvas id="consumptionGraph" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- PAGE 3: ADMIN REPORTS -->
<div id="adminPage" class="wrap" style="display:none">
  <div class="card">
    <h2>ЁЯУС Download Reports</h2>

    <!-- ===== Monthly Report Section ===== -->
    <h3 style="margin-top:20px; color:#0b3a66">ЁЯЧУ Download Monthly Report</h3>
    <label for="reportMonth">ЁЯУЕ Select Month & Year</label>
    <input id="reportMonth" type="month">
    <button class="btn" style="margin-top:10px" onclick="generateMonthlyReport()">ЁЯУе Download Monthly Report</button>
    <div id="monthlyReportStatus" class="small" style="margin-top:12px"></div>
    <div id="monthlyReportLink" style="margin-top:12px"></div>

    <hr style="margin:20px 0">

    <!-- ===== Three-Month (Quarterly) Report Section ===== -->
    <h3 style="margin-top:20px; color:#0b3a66">ЁЯУК Download Three-Month Report</h3>
    <label for="quarterYear">ЁЯУЕ Select Year</label>
    <input id="quarterYear" type="number" placeholder="рдЙрджрд╛. 2025" min="2020" max="2100">

    <label for="quarterSelect" style="margin-top:10px">ЁЯУЖ Select Quarter</label>
    <select id="quarterSelect">
      <option value="">--- Select Quarter ---</option>
      <option value="Q1">January тАУ March</option>
      <option value="Q2">April тАУ June</option>
      <option value="Q3">July тАУ September</option>
      <option value="Q4">October тАУ December</option>
    </select>

    <button class="btn" style="margin-top:10px" onclick="generateQuarterlyReport()">ЁЯУе Download Three-Month Report</button>
    <div id="quarterlyReportStatus" class="small" style="margin-top:12px"></div>
    <div id="quarterlyReportLink" style="margin-top:12px"></div>

    <hr style="margin:20px 0">

    <!-- ===== Pending Expenses Section ===== -->
    <h3 style="margin-top:20px; color:#0b3a66">ЁЯТ░ Download рдкреНрд░рд▓рдВрдмрд┐рдд рдЦрд░реНрдЪ рдЕрд╣рд╡рд╛рд▓</h3>
    <label for="expenseYear">ЁЯУЕ Select Year</label>
    <input id="expenseYear" type="number" placeholder="рдЙрджрд╛. 2025" min="2020" max="2100">

    <label for="expenseQuarter" style="margin-top:10px">ЁЯУЖ Select Quarter</label>
    <select id="expenseQuarter">
      <option value="">--- Select Quarter ---</option>
      <option value="Q1">January тАУ March</option>
      <option value="Q2">April тАУ June</option>
      <option value="Q3">July тАУ September</option>
      <option value="Q4">October тАУ December</option>
    </select>

    <button class="btn" style="margin-top:10px" onclick="generateExpenseReport()">ЁЯУе Download Expense Report</button>
    <div id="expenseReportStatus" class="small" style="margin-top:12px"></div>
    <div id="expenseReportLink" style="margin-top:12px"></div>

    <div class="actions" style="margin-top:20px">
      <button class="btn ghost" onclick="backToForm()">тмЕя╕П Back</button>
    </div>
  </div>
</div>



<script>
/* ---------- Admin Login + Reports Page ---------- */
const ADMIN_CODE = "123456";   // тЬЕ рддреБрдЭрд╛ fixed 6-digit code рдЗрдереЗ рдЯрд╛рдХ
// Mobile-optimized voice input initialization

document.addEventListener('DOMContentLoaded', function() {
  const micButton = document.getElementById('micLocation');
  const locationInput = document.getElementById('locationFromTo');
  
  if (!micButton) return;
  
  // Check device type
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile) {
    // Add mobile-specific attributes
    micButton.setAttribute('aria-label', 'рд╡реНрд╣реЙрдЗрд╕ рдЗрдирдкреБрдЯ рд╕реБрд░реВ рдХрд░рд╛');
  }
  
  // Initialize voice recognition
  initializeMobileVoiceInput();
});

function initializeMobileVoiceInput() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    // Fallback for unsupported browsers
    document.getElementById('micLocation').style.display = 'none';
    document.querySelector('.hint').textContent += " (рд╡реНрд╣реЙрдЗрд╕ рдЗрдирдкреБрдЯ рд╕рдкреЛрд░реНрдЯ рдирд╛рд╣реА)";
    return;
  }
  
  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.lang = 'mr-IN'; // Prioritize Marathi
  recognition.interimResults = false;
  
  setupVoiceRecognition(recognition);
}

function setupVoiceRecognition(recognition) {
  const micButton = document.getElementById('micLocation');
  const indicator = document.getElementById('locIndicator');
  
  micButton.addEventListener('click', function() {
    startVoiceRecognition(recognition, indicator);
  });
  
  // Additional mobile touch event
  micButton.addEventListener('touchend', function(e) {
    e.preventDefault();
    startVoiceRecognition(recognition, indicator);
  });
}

// Enhanced voice recognition with debugging
async function startVoiceRecognition() {
  const indicator = document.getElementById('locIndicator');
  const micButton = document.getElementById('micLocation');
  
  console.log("Start voice recognition called");
  
  try {
    // Clear previous messages
    indicator.textContent = "";
    
    // Check if speech recognition is available
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      throw new Error('Speech recognition not supported');
    }
    
    console.log("Speech recognition API available");
    
    // Request microphone permission first
    console.log("Requesting microphone permission...");
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      }
    });
    
    console.log("Microphone permission granted");
    
    // Stop the stream immediately
    stream.getTracks().forEach(track => track.stop());
    
    // Create new recognition instance each time
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    // Set language - try multiple options
    recognition.lang = 'mr-IN'; // Marathi India
    console.log("Recognition language set to:", recognition.lang);
    
    indicator.textContent = "рдРрдХрдд рдЖрд╣реЗ... рдмреЛрд▓рд╛ рдЖрддрд╛";
    indicator.style.color = "blue";
    micButton.style.background = "#e3f2fd";
    
    // Add event listeners
    recognition.onstart = function() {
      console.log("Speech recognition started");
      indicator.textContent = "рдРрдХрдд рдЖрд╣реЗ... рдмреЛрд▓рд╛";
      indicator.style.color = "blue";
    };
    
    recognition.onspeechstart = function() {
      console.log("Speech detected");
      indicator.textContent = "рдЖрд╡рд╛рдЬ рдРрдХреВ рдЖрд▓рд╛...";
    };
    
    recognition.onsoundstart = function() {
      console.log("Sound detected");
    };
    
    recognition.onresult = function(event) {
      console.log("Recognition result received");
      const result = event.results[0][0];
      const transcript = result.transcript;
      const confidence = result.confidence;
      
      console.log("Transcript:", transcript);
      console.log("Confidence:", confidence);
      
      const processedText = processVoiceInput(transcript);
      document.getElementById('locationFromTo').value = processedText;
      
      indicator.textContent = `рдУрд│рдЦрд▓реЗ! (${Math.round(confidence * 100)}%)`;
      indicator.style.color = "green";
      micButton.style.background = "";
      
      setTimeout(() => {
        indicator.textContent = "";
      }, 3000);
    };
    
    recognition.onerror = function(event) {
      console.error("Speech recognition error:", event.error);
      indicator.textContent = `рддреНрд░реБрдЯреА: ${getErrorMessage(event.error)}`;
      indicator.style.color = "red";
      micButton.style.background = "";
      
      // Show detailed error in console
      if (event.error === 'no-speech') {
        console.log("No speech detected - user might not have spoken");
      } else if (event.error === 'audio-capture') {
        console.log("Audio capture issue - check microphone");
      }
      
      setTimeout(() => {
        indicator.textContent = "";
      }, 4000);
    };
    
    recognition.onend = function() {
      console.log("Speech recognition ended");
      micButton.style.background = "";
      
      // If no error occurred but no result either
      if (indicator.textContent.includes("рдРрдХрдд рдЖрд╣реЗ")) {
        indicator.textContent = "рдЖрд╡рд╛рдЬ рдРрдХреВ рдЖрд▓рд╛ рдирд╛рд╣реА. рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.";
        indicator.style.color = "orange";
        
        setTimeout(() => {
          indicator.textContent = "";
        }, 3000);
      }
    };
    
    // Start recognition with timeout
    console.log("Starting recognition...");
    recognition.start();
    
    // Auto-stop after 10 seconds if no speech
    setTimeout(() => {
      if (indicator.textContent.includes("рдРрдХрдд рдЖрд╣реЗ")) {
        recognition.stop();
        console.log("Recognition timeout - no speech detected");
      }
    }, 10000);
    
  } catch (error) {
    console.error("Voice recognition setup error:", error);
    handleRecognitionError(error, indicator);
  }
}

function getErrorMessage(error) {
  const errorMessages = {
    'no-speech': 'рдЖрд╡рд╛рдЬ рдРрдХреВ рдЖрд▓рд╛ рдирд╛рд╣реА',
    'audio-capture': 'рдорд╛рдпрдХреНрд░реЛрдлреЛрди рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА',
    'not-allowed': 'рдорд╛рдпрдХреНрд░реЛрдлреЛрди рдкрд░рд╡рд╛рдирдЧреА рдирд╛рдХрд╛рд░рд▓реА',
    'network': 'рдиреЗрдЯрд╡рд░реНрдХ рддреНрд░реБрдЯреА',
    'service-not-allowed': 'рд╕реЗрд╡рд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА',
    'bad-grammar': 'рд╡реНрдпрд╛рдХрд░рдг рддреНрд░реБрдЯреА',
    'language-not-supported': 'рднрд╛рд╖рд╛ рд╕рдкреЛрд░реНрдЯ рдирд╛рд╣реА'
  };
  
  return errorMessages[error] || `рддреНрд░реБрдЯреА: ${error}`;
}

function showAdminLogin() {
  const code = prompt("ЁЯФС Admin Code рдЯрд╛рдХрд╛:");
  if (code === ADMIN_CODE) {
    document.getElementById("formPage").style.display = "none";
    document.getElementById("dashboardPage").style.display = "none";
    document.getElementById("adminPage").style.display = "block";
  } else {
    alert("тЭМ рдЪреБрдХреАрдЪрд╛ рдХреЛрдб. рдкрд░рдд рдкреНрд░рдпрддреНрди рдХрд░рд╛.");
  }
}

function backToForm() {
  document.getElementById("adminPage").style.display = "none";
  document.getElementById("formPage").style.display = "block";
}

/* ---------- Monthly Report Download ---------- */
function generateMonthlyReport() {
  const month = document.getElementById("reportMonth").value;
  if (!month) {
    document.getElementById("monthlyReportStatus").textContent = "тЪая╕П рдХреГрдкрдпрд╛ рдорд╣рд┐рдирд╛ рдирд┐рд╡рдбрд╛!";
    return;
  }
  document.getElementById("monthlyReportStatus").textContent = "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ...";
  setTimeout(()=>{
    document.getElementById("monthlyReportStatus").textContent = "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛!";
    document.getElementById("monthlyReportLink").innerHTML = 
      `<a href="https://docs.google.com/spreadsheets/d/XXXX/export?format=pdf" target="_blank">ЁЯУе Download PDF Report (${month})</a>`;
  },1500);
}

function generateQuarterlyReport() {
  const year = document.getElementById("quarterYear").value;
  const quarter = document.getElementById("quarterSelect").value;
  if (!year || !quarter) {
    document.getElementById("quarterlyReportStatus").textContent = "тЪая╕П рдХреГрдкрдпрд╛ рд╡рд░реНрд╖ рдЖрдгрд┐ Quarter рдирд┐рд╡рдбрд╛!";
    return;
  }
  document.getElementById("quarterlyReportStatus").textContent = "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ...";
  setTimeout(()=>{
    document.getElementById("quarterlyReportStatus").textContent = "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛!";
    document.getElementById("quarterlyReportLink").innerHTML =
      `<a href="https://docs.google.com/spreadsheets/d/YYYY/export?format=pdf" target="_blank">ЁЯУе Download Quarterly Report (${year} ${quarter})</a>`;
  },1500);
}

function generateExpenseReport() {
  const year = document.getElementById("expenseYear").value;
  const quarter = document.getElementById("expenseQuarter").value;
  if (!year || !quarter) {
    document.getElementById("expenseReportStatus").textContent = "тЪая╕П рдХреГрдкрдпрд╛ рд╡рд░реНрд╖ рдЖрдгрд┐ Quarter рдирд┐рд╡рдбрд╛!";
    return;
  }
  document.getElementById("expenseReportStatus").textContent = "тП│ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдХрд░рдд рдЖрд╣реЗ...";
  setTimeout(()=>{
    document.getElementById("expenseReportStatus").textContent = "тЬЕ рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рдЭрд╛рд▓рд╛!";
    document.getElementById("expenseReportLink").innerHTML =
      `<a href="https://docs.google.com/spreadsheets/d/ZZZZ/export?format=pdf" target="_blank">ЁЯУе Download Expense Report (${year} ${quarter})</a>`;
  },1500);
}


const scriptURL = "https://script.google.com/macros/s/AKfycbzT-vob4JQLy3ia3Kt26kX9XPOFd0-90zoucFXnLrFWEaO6Vitxpw-k_2SdEi8oIZiPww/exec";

/* ---------- Machine-wise Rates (L/hr) ---------- */
const machineRates = {
  "рдЬреЗрд╕реАрдмреА": 13,
  "рд╕реЕрдиреА": 23,
  "рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА": 20,
  "рд╢рд╛рдВрддреБрдИ": 14,
  "рдмреАрдИрдПрдордПрд▓": 14
};

/* ---------- Vehicle-wise Rates (Km/L) ---------- */
const vehicleRates = {
  // ЁЯЪЫ Tippers
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрез": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреи": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрек": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрел": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрем": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрен": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрео": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреп": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекреж": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрез": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрей": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрек": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрел": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрем": 1.6,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреоремрео": 1.6,
  "рдЖрдпрд╢рд░ релрежрезрем рдкреНрд░реЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ рейреп рдП рдбреА режрелреиреж": 2.3,

  // ЁЯЪЪ Transporters
  "рейрел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░реЕрдХреЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреирезрек": 1.9,
  "реирел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░рдХреНрд╕реЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреиреирел": 2.3,

  // ЁЯЪЩ Utility Vehicles
  "рдЯрд╛рдЯрд╛ рдЭреЗрдиреЙрди рдпреЛрджреНрдзрд╛ рдХреНрд░.рдПрдо рдПрдЪ режрео рдП рдкреА резреирекрек": 13,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдХреЕрдореНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ режрео рдЬреА режрейрекрек": 13,
  "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдкрд┐рдХрдЕрдк рдХреНрд░.рдПрдо рдПрдЪ резрез рдП рдмреА режреиренреж": 13
};

/* ---------- Data (Projects) ---------- */
const projects = {
  "рдХрд╛рд▓рд╡рд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛": ["рдзреЛрдо рдбрд╛рд╡рд╛ рдХрд╛рд▓рд╡рд╛","рддрд┐рд▓рд╛рд░реА рдЙрдЬрд╡рд╛ рдХрд╛рд▓рд╡рд╛","рдмрд╛рдВрджрд╛ рд╢рд╛рдЦрд╛ рдХрд╛рд▓рд╡рд╛","рд╕рд▓рдЧрд░реЗ рдореБрдЦреНрдп рдХрд╛рд▓рд╡рд╛"],
  "рдорд╛рддреАрдХрд╛рдо": [
    "рд╡рд╛рд╢рд┐рд╖реНрдареА рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ рддрд╛. рдЪрд┐рдкрд│реВрдг (рдЯрдкреНрдкрд╛-рез)",
    "рд╡рд╛рд╢рд┐рд╖реНрдареА рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ рддрд╛. рдЪрд┐рдкрд│реВрдг (рдЯрдкреНрдкрд╛-реи)",
    "рдЬрдЧрдмреБрдбреА рдирджреА рддрд╛.рдЦреЗрдб рдЬрд┐.рд░рддреНрдирд╛рдЧрд┐рд░реА рдпреЗрдереАрд▓ рдЧрд╛рд│ рд╡ рдмреЗрдЯреЗ рдХрд╛рдврдгреЗ",
    "рдореМрдЬреЗ рдорд╛рдЦрдЬрди рдпреЗрдереАрд▓ рд╕реНрдерд╛рдирд┐рдХ рдирджреАрддреАрд▓ рдЧрд╛рд│ рдХрд╛рдврдгреЗ. рдЬрд┐.рд░рддреНрдирд╛рдЧрд┐рд░реА"
  ]
};

/* ---------- Machine Lists ---------- */
const machines = {
  "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░": [
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрем",
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрен",
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренрео",
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренренреп",
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренреореж",
    "рдЬреЗрд╕реАрдмреА рдПрдирдПрдХреНрд╕рдЯреАреирежрел рдХреНрд░. рейрезрейреиренреорез",
    "рд╕реЕрдиреА рдПрд╕ рд╡рд╛рдп рейрелреж рдХреНрд░. ремреирео",
    "рд╕реЕрдиреА рдПрд╕ рд╡рд╛рдп рейрелреж рдХреНрд░. ремрелрео",
    "рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА рдИрдПрдХреНрд╕рейрелреж рдХреНрд░. режрекрежрек",
    "рдбреЛрдЭрд░ рд╢рд╛рдВрддреБрдИ рдПрд╕рдбреАрезрем рдХреНрд░. резрежреорепремрео",
    "рдбреЛрдЭрд░ рдмреАрдИрдПрдордПрд▓ рдмреАрдбреАреореж рдХреНрд░. резрелрейрекрен"
  ],

  "рдЯрд┐рдкрд░": [
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрез",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреи",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрек",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрел",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрем",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрен",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейрео",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорейреп",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекреж",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрез",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрей",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрек",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрел",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреорекрем",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреНрд▓рд╛рдЭреЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░. рдПрдо рдПрдЪ режрео рдП рдкреА рекреоремрео",
    "рдЖрдпрд╢рд░ релрежрезрем рдкреНрд░реЛ рдЯрд┐рдкреНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ рейреп рдП рдбреА режрелреиреж"
  ],

  "рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░": [
    "рейрел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░реЕрдХреЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреирезрек",
    "реирел рдЯрди рдорд╣рд┐рдВрджреНрд░рд╛ рдЯреНрд░рдХреНрд╕реЛ рдХреНрд░. рдПрдо рдПрдЪ режрео рдЬреА режреиреирел"
  ],

  "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ": [
    "рдЯрд╛рдЯрд╛ рдЭреЗрдиреЙрди рдпреЛрджреНрдзрд╛ рдХреНрд░.рдПрдо рдПрдЪ режрео рдП рдкреА резреирекрек",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдХреЕрдореНрдкрд░ рдХреНрд░.рдПрдо рдПрдЪ режрео рдЬреА режрейрекрек",
    "рдорд╣рд┐рдВрджреНрд░рд╛ рдмреЛрд▓реЗрд░реЛ рдкрд┐рдХрдЕрдк рдХреНрд░.рдПрдо рдПрдЪ резрез рдП рдмреА режреиренреж"
  ]
};

/* ---------- Utility: hide & clear extra fields ---------- */
function hideAndClearExtraFields(){
  // Hide merged location field and clear when moving to non-vehicle types
  const wrap = document.getElementById("locationWrapper");
  if (wrap) wrap.style.display = "none";

  const loc = document.getElementById("locationFromTo");
  const trip = document.getElementById("tripCount");
  if (loc){ loc.required = false; loc.value = ""; }
  if (trip){ trip.required = false; trip.value = ""; }
}


/* ---------- Data Store ---------- */
let records=[];

/* ---------- DOMContentLoaded ---------- */
document.addEventListener('DOMContentLoaded', function() {
  console.log("тЬЕ DOM loaded!");

// ---------- Dashboard Dropdown Dependency ----------
const dashMachineTypeSelect = document.getElementById("dashMachineType");
const dashMachineSelect = document.getElementById("dashMachine");

dashMachineTypeSelect.addEventListener("change", function () {
  const type = this.value;
  dashMachineSelect.innerHTML = '<option value="">--- рдорд╢реАрди рдирд┐рд╡рдбрд╛ ---</option>';
  if (machines[type]) {
    machines[type].forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      dashMachineSelect.appendChild(opt);
    });
  }
});

  // рдЖрдЬрдЪреА рддрд╛рд░реАрдЦ auto-fill
  const today = new Date();
  document.getElementById('todayDate').value = today.toISOString().split('T')[0];

  // рд╕реБрд░реБрд╡рд╛рддреАрд▓рд╛ extra fields рд▓рдкрд╡
  hideAndClearExtraFields();

  // рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░ -> рдкреНрд░рдХрд▓реНрдк рдпрд╛рджреА
  const workTypeSelect = document.getElementById("workType");
  const projectSelect = document.getElementById("projectName");
  const machineTypeSelect = document.getElementById("machineType");
  const machineSelect = document.getElementById("machine");

  workTypeSelect.addEventListener("change", function () {
    const workType = this.value;
    projectSelect.innerHTML = '<option value="" disabled selected>рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡ рдирд┐рд╡рдбрд╛...</option>';
    if (projects[workType]) {
      projects[workType].forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        projectSelect.appendChild(opt);
      });
    }
  });

  machineTypeSelect.addEventListener("change", function () {
  const type = this.value;
  machineSelect.innerHTML = '<option value="" disabled selected>рд╕рдпрдВрддреНрд░ рдирд┐рд╡рдбрд╛...</option>';
  if (machines[type]) {
    machines[type].forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      machineSelect.appendChild(opt);
    });
  }

  // Show merged location field only for these types
  const locWrap = document.getElementById("locationWrapper");
  const locInput = document.getElementById("locationFromTo");
  const tripInput = document.getElementById("tripCount");

  if (type === "рдЯрд┐рдкрд░" || type === "рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░" || type === "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ") {
    if (locWrap) locWrap.style.display = "block";
    if (locInput) { locInput.required = true; }
    if (tripInput) { tripInput.required = false; } // optional; manual allowed
  } else {
    // hide and clear only when non-vehicle
    if (locWrap) locWrap.style.display = "none";
    if (locInput) { locInput.required = false; locInput.value = ""; }
    if (tripInput) { tripInput.required = false; tripInput.value = ""; }
  }

  // focus flow
  machineSelect.focus();
});


  // Live Clock
  setInterval(()=>{
    const now=new Date();
    document.getElementById("nowStamp").textContent=
      now.toLocaleTimeString("mr-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  },1000);

  // рд╕реБрд░реБрд╡рд╛рддреАрд▓рд╛ Dashboard load
  loadDataFromSheet();
initVoiceForLocation();
});
// Auto-calc: Dashboard Reading (рддрд╛рд╕/km)
document.getElementById("startReading").addEventListener("input", calcReadingHours);
document.getElementById("endReading").addEventListener("input", calcReadingHours);

function calcReadingHours() {
  const start = parseFloat(document.getElementById("startReading").value) || 0;
  const end = parseFloat(document.getElementById("endReading").value) || 0;
  const total = end > start ? (end - start) : 0;

  const field = document.getElementById("totalHoursReading");
  field.value = total.toFixed(1);

  // Glow effect
  field.classList.add("glow");
  setTimeout(()=> field.classList.remove("glow"), 800);


  // тЬЕ label рдмрджрд▓рд▓реЗрд▓рдВ (рдлрдХреНрдд hint text рдЕрдкрдбреЗрдЯ рдХрд░рд╛рдпрдЪрдВ рдЕрд╕реЗрд▓ рддрд░):
  const hint = field.nextElementSibling;
  if (hint) {
    hint.textContent = "endReading - startReading = рдЖрдЬрдЪрд╛ рдПрдХреВрдг рддрд╛рд╕ / рдХрд┐рдореА";
  }
}
// Auto-calc: Shift hours
["shift1Start","shift1End","shift2Start","shift2End"].forEach(id=>{
  document.getElementById(id).addEventListener("input", calcShiftHours);
});

function calcShiftHours() {
  function toHours(time){
    if(!time) return 0;
    const [h,m] = time.split(":").map(Number);
    return h + m/60;
  }
  const s1 = toHours(document.getElementById("shift1Start").value);
  const e1 = toHours(document.getElementById("shift1End").value);
  const s2 = toHours(document.getElementById("shift2Start").value);
  const e2 = toHours(document.getElementById("shift2End").value);

  let total = 0;
  if(e1>s1) total += (e1-s1);
  if(e2>s2) total += (e2-s2);

  const field = document.getElementById("totalShiftHours");
  field.value = total.toFixed(1);

  // Glow effect add рдХрд░рд╛
  field.classList.add("glow");
  setTimeout(()=> field.classList.remove("glow"), 800);

}


/* ---------- Diesel Field Dependency (Fix) ---------- */
document.getElementById("dieselQty").addEventListener("input", function () {
  let qty = parseFloat(this.value);
  let timeField = document.getElementById("dieselTime");
  let readingField = document.getElementById("dieselReading");

  if (!isNaN(qty) && qty > 0) {
    timeField.disabled = false;
    timeField.required = true;

    readingField.disabled = false;   // тЬЕ Fix
    readingField.required = true;    // тЬЕ Fix
  } else {
    timeField.value = "";
    timeField.disabled = true;
    timeField.required = false;

    readingField.value = "";
    readingField.disabled = true;
    readingField.required = false;
  }
});



/* ---------- Submit ---------- */
document.getElementById("submitBtn").addEventListener("click", () => {
  const form = document.getElementById("mainForm");
  if (!form.checkValidity()) { 
    form.reportValidity(); 
    return; 
  }

  const data = {
    "рджрд┐рдирд╛рдВрдХ": document.getElementById("todayDate").value,
    "рдХрд╛рдорд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░": document.getElementById("workType").value,
    "рдкреНрд░рдХрд▓реНрдкрд╛рдЪреЗ рдирд╛рд╡": document.getElementById("projectName").value,
    "рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░": document.getElementById("machineType").value,
    "рдЪрд╛рд▓рдХ": document.getElementById("driver").value,
    "рдорд╢реАрди": document.getElementById("machine").value,
    "рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)": document.getElementById("dieselQty").value,
    "рдбрд┐рдЭреЗрд▓ рд╡реЗрд│": document.getElementById("dieselTime").value,
    "рдбрд┐рдЭреЗрд▓ reading": document.getElementById("dieselReading").value,
    "рд╕реБрд░реБрд╡рд╛рддреАрдЪреЗ reading": document.getElementById("startReading").value,
    "рд╢реЗрд╡рдЯрдЪреЗ reading": document.getElementById("endReading").value,
  "Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)": document.getElementById("totalHoursReading").value,
  "рдард┐рдХрд╛рдг_from_to": document.getElementById("locationFromTo") ? document.getElementById("locationFromTo").value.trim() : "",
  "рдПрдХреВрдг рдЯреНрд░рд┐рдкреНрд╕": document.getElementById("tripCount") ? document.getElementById("tripCount").value : "",
  "рд╢рд┐рдлреНрдЯ-рез рд╕реБрд░реВ рд╡реЗрд│": document.getElementById("shift1Start").value,
    "рд╢рд┐рдлреНрдЯ-рез рдмрдВрдж рд╡реЗрд│": document.getElementById("shift1End").value,
    "рд╢рд┐рдлреНрдЯ-реи рд╕реБрд░реВ рд╡реЗрд│": document.getElementById("shift2Start").value,
    "рд╢рд┐рдлреНрдЯ-реи рдмрдВрдж рд╡реЗрд│": document.getElementById("shift2End").value,
    "рдПрдХреВрдг рддрд╛рд╕ (shift)": document.getElementById("totalShiftHours").value
  };

  // ----- Remark Logic -----
  let remark = "тЬЕ рдХрд╛рдо рдЭрд╛рд▓реЗ";
  if ((!data["рд╕реБрд░реБрд╡рд╛рддреАрдЪреЗ reading"] && !data["рд╢реЗрд╡рдЯрдЪреЗ reading"]) && (!data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] || data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] == 0)) {
    remark = "ЁЯЪл рдХрд╛рдо рдЭрд╛рд▓реЗ рдирд╛рд╣реА";
  } else if (data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] == 0 || data["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"] === "") {
    remark = "тЪая╕П рдХрд╛рдо рдЭрд╛рд▓реЗ, рдкрдг рдбрд┐рдЭреЗрд▓ рднрд░рд▓реЗ рдирд╛рд╣реА";
  }
  data["рдЯреАрдк"] = remark;

  fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if (res.result === "success") {
      document.getElementById("status").textContent = "тЬЕ рдорд╛рд╣рд┐рддреА Sheet рдордзреНрдпреЗ рдЬрддрди рдЭрд╛рд▓реА!";
      showPopup();   // тЬЕ popup рджрд┐рд╕реЗрд▓ рдЖрдгрд┐ 2 рд╕реЗрдХрдВрджрд╛рдд auto-close рд╣реЛрдИрд▓

      // ЁЯФД 2 рд╕реЗрдХрдВрджрд╛рдВрдиреА Dashboard Page рд╡рд░ redirect рд╣реЛрдИрд▓
      setTimeout(()=> redirectToDashboard(), 2000);

      form.reset();

      // Reset today's date after form reset
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('todayDate').value = formattedDate;

      // Hide & clear extras
      hideAndClearExtraFields();

      setTimeout(() => document.getElementById("todayDate").focus(), 200);

      // тЬЕ рд╢реЗрд╡рдЯреА dashboard refresh
      loadDataFromSheet();
    } else {
      document.getElementById("status").textContent = "тЪая╕П server рдиреЗ error рджрд┐рд▓рд╛.";
    }
  })
  .catch(err => {
    console.error(err);
    document.getElementById("status").textContent = "тЪая╕П рдПрд░рд░: рдорд╛рд╣рд┐рддреА рдЬрддрди рдЭрд╛рд▓реА рдирд╛рд╣реА!";
  });
});

/* ---------- Reset ---------- */
document.getElementById("resetBtn").addEventListener("click",()=>{
  const form = document.getElementById("mainForm");
  form.reset();

  // Reset today's date after form reset
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  document.getElementById('todayDate').value = formattedDate;

  // Hide & clear extras
  hideAndClearExtraFields();

  document.getElementById("status").innerHTML="тЩ╗я╕П рдлреЙрд░реНрдо рд░реАрд╕реЗрдЯ рдЭрд╛рд▓рд╛.";
  setTimeout(()=>document.getElementById("todayDate").focus(),200);
});


/* ---------- Dashboard ---------- */
let chart;

function toNumber(v){
  if (v == null) return 0;
  const s = String(v).trim().replace(/,/g, '.').replace(/[^\d\.\-]/g, '');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}

function getRateForMachine(machine) {
  // Machine type (L/hr logic)
  if (machine.includes("рдЬреЗрд╕реАрдмреА")) return machineRates["рдЬреЗрд╕реАрдмреА"];
  if (machine.includes("рд╕реЕрдиреА")) return machineRates["рд╕реЕрдиреА"];
  if (machine.includes("рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА")) return machineRates["рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА"];
  if (machine.includes("рд╢рд╛рдВрддреБрдИ")) return machineRates["рд╢рд╛рдВрддреБрдИ"];
  if (machine.includes("рдмреАрдИрдПрдордПрд▓")) return machineRates["рдмреАрдИрдПрдордПрд▓"];

  // Vehicle type (Km/L logic)
  if (vehicleRates[machine]) return vehicleRates[machine];

  return 10; // fallback
}

function updateSummary(filtered) {
  if (filtered.length === 0) {
    document.getElementById("summaryDiv").innerHTML = "рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА";
    return;
  }

  // Group by machine (not machine|operator)
  let group = {};
  filtered.forEach(r => {
    const machine = r["рдорд╢реАрди"] || "Unknown";
    const key = machine; // machine-wise grouping
    const total = toNumber(r["Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)"]);
    const diesel = toNumber(r["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"]);
    let type = r["рд╕рдпрдВрддреНрд░рд╛рдЪрд╛ рдкреНрд░рдХрд╛рд░"] || "";

    if (!type) {
      if (machine.includes("рдЬреЗрд╕реАрдмреА") || machine.includes("рд╕реЕрдиреА") ||
          machine.includes("рдЯрд╛рдЯрд╛ рд╣рд┐рддрд╛рдЪреА") || machine.includes("рдбреЛрдЭрд░")) {
        type = "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░";
      } else if (machine.includes("рдЯрд┐рдкрд░")) {
        type = "рдЯрд┐рдкрд░";
      } else if (machine.includes("рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░")) {
        type = "рдЯреНрд░рд╛рдиреНрд╕рдкреЛрд░реНрдЯрд░";
      } else if (machine.includes("рдпреБрдЯрд┐рд▓рд┐рдЯреА")) {
        type = "рдпреБрдЯрд┐рд▓рд┐рдЯреА рд╡рд╛рд╣рдиреЗ";
      }
    }

    if (!group[key]) {
      group[key] = { totalHours: 0, totalDiesel: 0, machine, operators: new Set(), type };
    }
    group[key].totalHours += total;
    group[key].totalDiesel += diesel;
    if (r["рдЪрд╛рд▓рдХ"]) group[key].operators.add(r["рдЪрд╛рд▓рдХ"]);
  });

  console.log("ЁЯФН Raw Group Data:", group);

  // Calculate average (Machines: L/hr, Vehicles: Km/L)
  let entries = Object.values(group).map(g => {
    let avg = 0;
    if (g.type === "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░") {
      if (g.totalHours > 0) avg = g.totalDiesel / g.totalHours; // L/hr
    } else {
      if (g.totalDiesel > 0) avg = g.totalHours / g.totalDiesel; // Km/L
    }
    return {
      machine: g.machine,
      operators: Array.from(g.operators).join(', '), // operators list
      type: g.type,
      totalHours: g.totalHours,
      totalDiesel: g.totalDiesel,
      avgDiesel: avg
    };
  });

  console.log("ЁЯФН Entries with Avg:", entries);

  // Separate machines vs vehicles (only those with avg > 0)
  let machineEntries = entries.filter(e => e.type === "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░" && e.avgDiesel > 0);
  let vehicleEntries = entries.filter(e => e.type !== "рдбреЛрдЭрд░/рдПрдХреНрд╕реНрдХреЕрд╡реНрд╣реЗрдЯрд░" && e.avgDiesel > 0);

  // Best / Worst for machines (L/hr): lower L/hr is better
  let bestMachine = null, worstMachine = null;
  if (machineEntries.length) {
    bestMachine = machineEntries.reduce((a,b)=> (a.avgDiesel < b.avgDiesel ? a : b));
    worstMachine = machineEntries.reduce((a,b)=> (a.avgDiesel > b.avgDiesel ? a : b));
  }

  // Best / Worst for vehicles (Km/L): higher Km/L is better
  let bestVehicle = null, worstVehicle = null;
  if (vehicleEntries.length) {
    bestVehicle = vehicleEntries.reduce((a,b)=> (a.avgDiesel > b.avgDiesel ? a : b));
    worstVehicle = vehicleEntries.reduce((a,b)=> (a.avgDiesel < b.avgDiesel ? a : b));
  }

  // Build 4-row summary (machine-topper, vehicle-topper, machine-bottom, vehicle-bottom)
  let html = `
    <h3 class="summary-heading">ЁЯУК рдорд╢реАрди рдХрд╛рдордЧрд┐рд░реАрдЪрд╛ рд╕рд╛рд░рд╛рдВрд╢</h3>
    <div class="table-container">
      <table border="1" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>Category</th>
            <th>Machine/Vehicle</th>
            <th>Operators</th>
            <th>Average</th>
            <th>Remark</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ЁЯЪЬ рд╕рд░реНрд╡рд╛рдд рдЪрд╛рдВрдЧрд▓реЗ Machine Average</td>
            <td>${bestMachine ? bestMachine.machine : "-"}</td>
            <td>${bestMachine ? bestMachine.operators : "-"}</td>
            <td>${bestMachine ? bestMachine.avgDiesel.toFixed(2)+" L/hr" : "-"}</td>
            <td>ЁЯСП рдЕрднрд┐рдирдВрджрди !</td>
          </tr>
          <tr>
            <td>ЁЯЪЪ рд╕рд░реНрд╡рд╛рдд рдЪрд╛рдВрдЧрд▓реЗ Vehicle Average</td>
            <td>${bestVehicle ? bestVehicle.machine : "-"}</td>
            <td>${bestVehicle ? bestVehicle.operators : "-"}</td>
            <td>${bestVehicle ? bestVehicle.avgDiesel.toFixed(2)+" Km/L" : "-"}</td>
            <td>ЁЯСП рдЕрднрд┐рдирдВрджрди !</td>
          </tr>
          <tr>
            <td>ЁЯЪЬ рд╕рд░реНрд╡рд╛рдд рдЦрд░рд╛рдм Machine Average</td>
            <td>${worstMachine ? worstMachine.machine : "-"}</td>
            <td>${worstMachine ? worstMachine.operators : "-"}</td>
            <td>${worstMachine ? worstMachine.avgDiesel.toFixed(2)+" L/hr" : "-"}</td>
            <td>тЪая╕П рдЦрдмрд░рджрд╛рд░реА рдШреНрдпрд╛</td>
          </tr>
          <tr>
            <td>ЁЯЪЪ рд╕рд░реНрд╡рд╛рдд рдЦрд░рд╛рдм Vehicle Average</td>
            <td>${worstVehicle ? worstVehicle.machine : "-"}</td>
            <td>${worstVehicle ? worstVehicle.operators : "-"}</td>
            <td>${worstVehicle ? worstVehicle.avgDiesel.toFixed(2)+" Km/L" : "-"}</td>
            <td>тЪая╕П рд╕реБрдзрд╛рд░рдгрд╛ рдХрд░рдгреЗ</td>
          </tr>
        </tbody>
      </table>
    </div>`;

  document.getElementById("summaryDiv").innerHTML = html;
}

function updateDashboard() {
  let machineFilter = document.getElementById("dashMachine").value;
  let startDate = document.getElementById("startDate").value;
  let endDate = document.getElementById("endDate").value;

  fetch('https://opensheet.elk.sh/1DvrWe99U3qLPm0Zko77zZfPjnbiT3PwEaRY5dP2t820/Sheet1')
    .then(res => res.json())
    .then(data => {
      let filteredAll = data.filter(r => {
        if (startDate && endDate) {
          let d = new Date(r["рджрд┐рдирд╛рдВрдХ"]);
          return (d >= new Date(startDate) && d <= new Date(endDate));
        }
        return true;
      });

      let filtered = filteredAll.filter(r => {
        return !machineFilter || r["рдорд╢реАрди"] === machineFilter;
      });

      updateSummary(filteredAll);

      let totalHours = 0, totalDiesel = 0;
filtered.forEach(r => {
  totalHours += toNumber(r["Dashboard рдПрдХреВрдг (рддрд╛рд╕/km)"]);
  totalDiesel += toNumber(r["рдбрд┐рдЭреЗрд▓ (рд▓рд┐рдЯрд░)"]);
});

// Machine name рдЖрдзреА рдард░рд╡
let machineName = machineFilter ? machineFilter : (filtered[0] ? filtered[0]["рдорд╢реАрди"] : "N/A");

// рдЖрддрд╛ unit logic (рдПрдХрджрд╛рдЪ declare рдХрд░рд╛)
const isVehicle = Object.prototype.hasOwnProperty.call(vehicleRates, machineName);
const workUnit = isVehicle ? "рдХрд┐рдореА" : "рддрд╛рд╕";

// Summary line
document.getElementById("dashTotal").textContent = 
  `тП▒ ${totalHours.toFixed(1)} ${workUnit}, тЫ╜ ${totalDiesel.toFixed(1)} рд▓рд┐рдЯрд░`;

document.getElementById("dashCount").textContent = filtered.length;

// Allowed calculation
let allowed = 0;
if (machineName && Object.prototype.hasOwnProperty.call(vehicleRates, machineName)) {
  allowed = totalHours / vehicleRates[machineName];
} else {
  let rate = getRateForMachine(machineName);
  allowed = rate * totalHours;
}

// тЬЕ рдпреЗрдереЗ рдкреБрдиреНрд╣рд╛ isVehicle/workUnit declare рдХрд░реВ рдирдХреЛрд╕ тАФ рд╡рд░рдЪреЗ reuse рдХрд░
let tbody = document.querySelector("#dashTable tbody");
tbody.innerHTML = "";
if (filtered.length) {
  const remark = totalDiesel <= allowed ? "рдпреЛрдЧреНрдп" : "рдЬрд╛рд╕реНрдд";
  const remarkClass = totalDiesel <= allowed ? "green" : "red";

  let row = document.createElement("tr");
  row.innerHTML = `
    <td>${machineName}</td>
    <td>${totalHours.toFixed(1)} ${workUnit}</td>
    <td>${totalDiesel.toFixed(1)} рд▓рд┐рдЯрд░</td>
    <td>${allowed.toFixed(1)} рд▓рд┐рдЯрд░</td>
    <td class="${remarkClass}">${remark}</td>`;
  tbody.appendChild(row);
} else {
  tbody.innerHTML = `<tr><td colspan="5">рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА</td></tr>`;
}

      let labels = [];
      let allowedData = [];
      let actualData = [];
      if (filtered.length) {
        labels = [machineName];
        allowedData = [(allowed).toFixed(1)];
        actualData = [(totalDiesel).toFixed(1)];
      }
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("consumptionGraph"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            {label: `Allowed (рд▓рд┐рдЯрд░)`, data: allowedData, backgroundColor:"rgba(54,162,235,0.6)"},
            {label: `Actual (рд▓рд┐рдЯрд░)`, data: actualData, backgroundColor:"rgba(255,99,132,0.6)"}
          ]
        },
        options:{responsive:true,plugins:{legend:{position:"top"}}}
      });
    });
}

document.getElementById("dashFetchBtn").addEventListener("click",e=>{
  e.preventDefault();
  updateDashboard();
});

// Google Sheet рдордзреВрди рдбреЗрдЯрд╛ рд╡рд╛рдЪрдгреЗ
function loadDataFromSheet(){
  fetch('https://opensheet.elk.sh/1DvrWe99U3qLPm0Zko77zZfPjnbiT3PwEaRY5dP2t820/Sheet1')
    .then(res => res.json())
    .then(data => {
      records = data;
      updateDashboard();
    })
    .catch(err => console.error("рд▓реЛрдбрд┐рдВрдЧрдордзреНрдпреЗ рдЕрдбрдЪрдг:",err));
}

// ---------- Redirect Function ----------
function redirectToDashboard(){
  document.getElementById("formPage").style.display = "none";
  document.getElementById("dashboardPage").style.display = "block";
  updateDashboard(); // тЬЕ Dashboard рддрд╛рдЬрдВ рд▓реЛрдб рд╣реЛрдИрд▓
}
// ---------- Show Form Function ----------
function showFormPage(){
  document.getElementById("dashboardPage").style.display = "none";
  document.getElementById("formPage").style.display = "block";
document.getElementById("status").textContent = "ЁЯЫИ рд╕рд░реНрд╡ рдорд╛рд╣рд┐рддреА рднрд░реВрди 'рд╕рдмрдорд┐рдЯ рдХрд░рд╛' рджрд╛рдмрд╛.";

  // ЁЯФД рдлреЙрд░реНрдо reset
  document.getElementById("mainForm").reset();
  const today = new Date();
  document.getElementById('todayDate').value = today.toISOString().split('T')[0];
}

// ---------- Success Popup ----------
function showPopup(message = "рддреБрдордЪреА рдорд╛рд╣рд┐рддреА Google Sheet рдордзреНрдпреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдЭрд╛рд▓реА рдЖрд╣реЗ.") {
  const popup = document.getElementById("successPopup");
  if (!popup) return;

  // Text рдЕрдкрдбреЗрдЯ
  const p = popup.querySelector(".popup-content p");
  if (p) p.textContent = message;

  // тЬФя╕П animation reset рдХрд░рд╛
  const tick = popup.querySelector(".checkmark");
  if (tick) {
    tick.classList.remove("draw");   // рдЖрдзреА рдХрд╛рдв
    void tick.offsetWidth;           // reflow (animation reset рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА trick)
    tick.classList.add("draw");      // рдкреБрдиреНрд╣рд╛ add тЖТ animation play рд╣реЛрдИрд▓
  }

  // Popup рджрд╛рдЦрд╡рд╛
  popup.classList.add("show");
  popup.setAttribute("aria-hidden", "false");

  // 2 рд╕реЗрдХрдВрджрд╛рдд auto hide
  setTimeout(() => {
    popup.classList.remove("show");
    popup.setAttribute("aria-hidden", "true");
  }, 2000);
}
// ---------------- Voice input for merged FromтЖТTo ----------------
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

function initVoiceForLocation(){
  const input = document.getElementById('locationFromTo');
  const btn = document.getElementById('micLocation');
  const ind = document.getElementById('locIndicator');
  if (!btn || !input) return;

  if (!SpeechRecognition) {
    btn.disabled = true;
    ind.textContent = 'рд╡реНрд╣реЙрдЗрд╕ рд╕рдкреЛрд░реНрдЯ рдирд╛рд╣реА';
    return;
  }

  const rec = new SpeechRecognition();
  rec.lang = 'mr-IN';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.continuous = false;

  let listening = false;
  btn.addEventListener('click', ()=>{
    try {
      if (!listening) { rec.start(); listening = true; btn.classList.add('recording'); ind.textContent = 'рдРрдХрдд рдЖрд╣реЗ...'; }
      else { rec.stop(); }
    } catch(e) { console.warn(e); }
  });

  rec.addEventListener('result', ev=>{
    const text = ev.results[0][0].transcript.trim();
    input.value = text;
    ind.textContent = 'рднрд░рд▓реЗ: ' + text;

    // try to extract a number and fill tripCount
    const n = extractTripCount(text);
    if (n !== '') {
      const tripEl = document.getElementById('tripCount');
      if (tripEl) tripEl.value = n;
    }
  });

  rec.addEventListener('end', ()=>{ listening = false; btn.classList.remove('recording'); if(!ind.textContent.startsWith('рднрд░рд▓реЗ')) ind.textContent = 'рдРрдХрдгреЗ рдкреВрд░реНрдг'; });
  rec.addEventListener('error', ev=>{ console.error(ev); ind.textContent = 'рдПрд░рд░: '+ev.error; listening=false; btn.classList.remove('recording'); });
}

function extractTripCount(text){
  if (!text) return '';
  const m = text.match(/(\d+)\s*(?:trips?|рдЯреНрд░рд┐рдкреНрд╕?|рдЯреНрд░рд┐рдк)?/i);
  if (m && m[1]) return m[1];
  const m2 = text.match(/(\d+)/);
  return m2 ? m2[1] : '';
}

// Initialize voice on DOM ready (add call if DOMContentLoaded exists)
try {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVoiceForLocation);
  } else {
    initVoiceForLocation();
  }
} catch(e){ console.warn('voice init error', e); }

</script>

<!-- Success popup (auto-close) -->
<div id="successPopup" class="popup" aria-hidden="true">
  <div class="popup-content">
    <div class="checkmark-circle">
      <div class="background"></div>
      <div class="checkmark"></div>
    </div>
    <h2>рдорд╛рд╣рд┐рддреА рдЬрддрди рдЭрд╛рд▓реА!</h2>
    <p>рддреБрдордЪреА рдорд╛рд╣рд┐рддреА Google Sheet рдордзреНрдпреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдЭрд╛рд▓реА рдЖрд╣реЗ.</p>
  </div>
</div>
</body>
</html>
